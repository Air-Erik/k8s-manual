# Cluster Bootstrap (kubeadm + kube-vip)

> **Статус:** 🟡 ГОТОВО к передаче AI-агенту
> **Ответственный:** AI-исполнитель + Оператор
> **Зависимости:** ✅ VM Template готов (02-vm-preparation.md)

---

## 🎯 Цель

Инициализировать HA Kubernetes кластер с 3 Control Plane узлами и 2 Worker узлами, используя kube-vip для управления API VIP.

### 👉 Переходите к детальной инструкции:
**[research/cluster-bootstrap/AI-AGENT-TASK.md](../research/cluster-bootstrap/AI-AGENT-TASK.md)**

Этот документ содержит:
- Архитектуру HA кластера с kube-vip
- kubeadm конфигурации для всех типов узлов
- Пошаговые инструкции bootstrap процесса
- kube-vip настройки для API VIP
- Комплексные валидационные процедуры

---

## Исходные данные (готовы ✅)

**Сетевые параметры:**
- **Segment:** `k8s-zeon-dev-segment` (10.246.10.0/24)
- **Gateway:** `10.246.10.1`

**IP Allocation:**
```yaml
Control_Plane:
  cp-01: 10.246.10.10
  cp-02: 10.246.10.11
  cp-03: 10.246.10.12

Workers:
  w-01: 10.246.10.20
  w-02: 10.246.10.21

Services:
  API_VIP: 10.246.10.100        # kube-vip managed
  MetalLB_Pool: 10.246.10.200-220  # будущее
```

**VM Template:**
- **Name:** [будет указано оператором]
- **OS:** Ubuntu 24.04 LTS с предустановленными K8s компонентами
- **Cloud-init:** Готов к автоматизации

---

## Архитектура кластера

```
┌─────────────────────────────────────────────────────────────┐
│                    NSX-T Segment                            │
│                 k8s-zeon-dev-segment                        │
│                   10.246.10.0/24                           │
└─────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
         ┌────▼────┐     ┌────▼────┐     ┌────▼────┐
         │  cp-01  │     │  cp-02  │     │  cp-03  │
         │ .10.10  │     │ .10.11  │     │ .10.12  │
         └─────────┘     └─────────┘     └─────────┘
              │               │               │
              └───────────────┼───────────────┘
                              │
                    ┌─────────▼─────────┐
                    │     kube-vip      │
                    │   API VIP: .100   │
                    └───────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
         ┌────▼────┐     ┌────▼────┐
         │  w-01   │     │  w-02   │
         │ .10.20  │     │ .10.21  │
         └─────────┘     └─────────┘
```

---

## Артефакты на выходе

После завершения работы с AI-агентом:

### Документация
- [ ] **Архитектура и планирование** HA кластера
- [ ] **kubeadm конфигурации** для всех типов узлов
- [ ] **kube-vip настройки** для API VIP управления
- [ ] **Инструкции клонирования** VM из Template
- [ ] **Пошаговые процедуры** bootstrap всех узлов
- [ ] **Валидационные процедуры** и troubleshooting

### Практические артефакты
- [ ] **Работающий кластер:** 3 CP + 2 Workers в HA конфигурации
- [ ] **Скрипты автоматизации:**
  - `scripts/pre-bootstrap-setup.sh` — подготовка нод
  - `scripts/cluster-validation.sh` — валидация кластера
  - `scripts/generate-join-commands.sh` — генерация join команд
  - `scripts/etcd-backup.sh` — backup etcd
- [ ] **kubeadm конфигурации:**
  - `manifests/kubeadm-config-cp01.yaml` — первый CP
  - `manifests/kubeadm-config-join-cp.yaml` — дополнительные CP
  - `manifests/kubeadm-config-join-worker.yaml` — worker узлы
- [ ] **kube-vip манифесты:**
  - `manifests/kube-vip.yaml` — kube-vip для API VIP
- [ ] **Справочные материалы:**
  - `cluster-info.yaml` — параметры кластера
  - `node-inventory.md` — инвентарь узлов

---

## Задачи

### Этап 1: Планирование и конфигурации
- [ ] AI-агент создаёт архитектурный план HA кластера
- [ ] AI-агент создаёт kubeadm конфигурации для всех узлов
- [ ] AI-агент создаёт kube-vip манифесты для API VIP

### Этап 2: VM клонирование и подготовка
- [ ] AI-агент создаёт инструкции клонирования VM из Template
- [ ] AI-агент создаёт скрипты подготовки нод к bootstrap
- [ ] Оператор клонирует 5 VM (3 CP + 2 Workers) с cloud-init

### Этап 3: Bootstrap первого Control Plane
- [ ] AI-агент создаёт процедуры инициализации первого CP
- [ ] Оператор настраивает kube-vip на cp-01
- [ ] Оператор выполняет kubeadm init с HA конфигурацией

### Этап 4: HA Control Plane setup
- [ ] AI-агент создаёт процедуры присоединения CP узлов
- [ ] Оператор присоединяет cp-02 к кластеру
- [ ] Оператор присоединяет cp-03 к кластеру
- [ ] Валидация HA Control Plane и etcd кластера

### Этап 5: Worker nodes join
- [ ] AI-агент создаёт процедуры присоединения Worker узлов
- [ ] Оператор присоединяет w-01 и w-02 к кластеру
- [ ] Валидация всех узлов кластера

### Этап 6: Валидация и документация
- [ ] AI-агент создаёт комплексные валидационные процедуры
- [ ] AI-агент создаёт troubleshooting guide
- [ ] Оператор проводит финальную валидацию кластера
- [ ] AI-агент документирует итоговые параметры кластера

---

## Быстрый старт для AI-агента

Если ты AI-агент, назначенный на эту задачу:

1. **Прочитай** [research/cluster-bootstrap/AI-AGENT-TASK.md](../research/cluster-bootstrap/AI-AGENT-TASK.md)
2. **Начни с Этапа 1** (Планирование и конфигурации)
3. **Создавай артефакты** последовательно (01, 02, 03, ...)
4. **Пиши готовые к использованию конфигурации** (без TODO)
5. **Учитывай HA требования** и kube-vip специфику

---

## Критерии завершения задачи

Задача считается завершённой, когда:

✅ **Кластер инициализирован:** 3 CP + 2 Workers в HA конфигурации
✅ **HA настроено:** kube-vip управляет API VIP (10.246.10.100)
✅ **etcd кластер:** 3 члена, stacked topology, здоров
✅ **API доступен:** через VIP, failover работает
✅ **Все узлы присоединены:** в состоянии NotReady (ожидают CNI)
✅ **Валидация пройдена:** системные поды работают, кластер отвечает
✅ **Документация полная:** все процедуры воспроизводимы
✅ **Готовность к CNI:** Pod subnet настроен для Cilium

---

**Следующий шаг после этой задачи:** Этап 1.2 — CNI Setup (Cilium) (`docs/04-cni-setup.md`)
