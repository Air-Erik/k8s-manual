# NSX-T Configuration for Kubernetes Cluster

> **–°—Ç–∞—Ç—É—Å:** üü¢ COMPLETED (–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
> **–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-17
> **–û–ø–µ—Ä–∞—Ç–æ—Ä:** Ayrapetov_es

---

## –û–±–∑–æ—Ä

–≠—Ç–∞ –ø–∞–ø–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç **—Ñ–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ NSX-T** –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** –û—Ç–¥–µ–ª—å–Ω—ã–π T1 Gateway + –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Tanzu –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.

---

## –î–æ–∫—É–º–µ–Ω—Ç—ã

### üìã –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –î–æ–∫—É–º–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|----------|--------|
| [`segments.md`](./segments.md) | **–û—Å–Ω–æ–≤–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç** ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–µ–≥–º–µ–Ω—Ç–∞, IP-–ø–ª–∞–Ω, DNS, –≤–∞–ª–∏–¥–∞—Ü–∏—è | ‚úÖ Complete |
| [`t1-gateway-config.md`](./t1-gateway-config.md) | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è T1 Gateway, Route Advertisement, Gateway Firewall | ‚úÖ Complete |
| [`nat-configuration.md`](./nat-configuration.md) | NAT –ø—Ä–∞–≤–∏–ª–∞, —Ç—Ä–∞—Ñ–∏–∫-—Ñ–ª–æ—É, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | ‚úÖ Complete |

---

## –ë—ã—Å—Ç—Ä—ã–π —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫

### üéØ –ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|------------|
| **T1 Gateway** | `T1-k8s-zeon-dev` | –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –¥–ª—è k8s –∫–ª–∞—Å—Ç–µ—Ä–∞ |
| **–°–µ–≥–º–µ–Ω—Ç** | `k8s-zeon-dev-segment` | –°–µ—Ç—å –¥–ª—è k8s –Ω–æ–¥ |
| **VM Subnet** | `10.246.10.0/24` | IP-–¥–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –Ω–æ–¥ |
| **Gateway IP** | `10.246.10.1/24` | –®–ª—é–∑ –¥–ª—è –Ω–æ–¥ |
| **SNAT IP** | `172.16.50.170` | Egress-IP –¥–ª—è –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ |
| **VIP Pool** | `172.16.50.192/27` | –ü—É–ª –¥–ª—è LoadBalancer/Ingress |
| **DNS** | `172.17.10.3` + `8.8.8.8` | DNS —Å–µ—Ä–≤–µ—Ä—ã |

### üîß NAT –ø—Ä–∞–≤–∏–ª–∞ (T1-k8s-zeon-dev)

| –ü—Ä–∞–≤–∏–ª–æ | –¢–∏–ø | –ò—Å—Ç–æ—á–Ω–∏–∫ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –î–µ–π—Å—Ç–≤–∏–µ |
|---------|-----|----------|------------|----------|
| `no_snat_to_internal` | No-SNAT | `10.246.10.0/24` | `Any` | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π IP |
| `no_snat_to_vips` | No-SNAT | `10.246.10.0/24` | `172.16.50.192/27` | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–π IP |
| `snat_to_internet` | SNAT | `10.246.10.0/24` | `Any` | `172.16.50.170` |

### üìä IP-–ø–ª–∞–Ω (10.246.10.0/24)

| IP Range | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –°—Ç–∞—Ç—É—Å |
|----------|------------|--------|
| `10.246.10.1` | Gateway (T1) | ‚úÖ Reserved |
| `10.246.10.10-12` | Control Plane (3 –Ω–æ–¥—ã) | ‚úÖ Reserved |
| `10.246.10.20-30` | Worker Nodes (10 –Ω–æ–¥) | ‚úÖ Reserved |
| `10.246.10.100` | API VIP (kube-vip) | ‚úÖ Reserved |
| `10.246.10.200-220` | MetalLB Pool (20 IP) | ‚úÖ Reserved |
| `10.246.10.50-99` | Future Use | ‚úÖ Available |

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Kubernetes Deployment

### –≠—Ç–∞–ø 0.2: VM Preparation
- **Subnet:** `10.246.10.0/24` –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö IP
- **Gateway:** `10.246.10.1` –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏
- **DNS:** `172.17.10.3, 8.8.8.8` –¥–ª—è cloud-init

### –≠—Ç–∞–ø 1.1: Cluster Bootstrap
- **API VIP:** `10.246.10.100` –¥–ª—è kube-vip
- **Control Plane IPs:** `10.246.10.10-12` –¥–ª—è kubeadm init

### –≠—Ç–∞–ø 1.4: MetalLB Setup
- **IP Pool:** `10.246.10.200-220` –¥–ª—è LoadBalancer services
- **No-SNAT:** –∫ VIP –ø—É–ª—É `172.16.50.192/27`

### –≠—Ç–∞–ø 1.5: Ingress Setup
- **Ingress VIP:** –∏–∑ –ø—É–ª–∞ `172.16.50.192/27`
- **No-SNAT:** –¥–ª—è health checks –æ—Ç –Ω–æ–¥

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–Ω–æ—Å—Ç–∏
```bash
# –° k8s –Ω–æ–¥—ã:
ping 8.8.8.8                    # –ò–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ SNAT
curl ifconfig.me                # –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å 172.16.50.170
ping 172.16.50.200              # VIP –±–µ–∑ hairpin –ø—Ä–æ–±–ª–µ–º
```

### NSX UI –ø—Ä–æ–≤–µ—Ä–∫–∏
```bash
# NAT —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
# Networking ‚Üí Tier-1 Gateways ‚Üí T1-k8s-zeon-dev ‚Üí NAT ‚Üí Rules

# Route Advertisement:
# Networking ‚Üí Tier-0 Gateways ‚Üí TO-GW ‚Üí Routing ‚Üí Routes

# Traceflow:
# Plan & Troubleshoot ‚Üí Traceflow
```

---

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ò–∑–æ–ª—è—Ü–∏—è
- **–û—Ç–¥–µ–ª—å–Ω—ã–π T1** ‚Äî –ø–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏—è –æ—Ç Tanzu –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- **–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–¥—Å–µ—Ç—å** ‚Äî –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ç—è–º–∏
- **–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π SNAT** ‚Äî –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π egress-—Ç—Ä–∞—Ñ–∏–∫

### NAT Security
- **No-SNAT –ø—Ä–∞–≤–∏–ª–∞** ‚Äî —Å–æ—Ö—Ä–∞–Ω—è—é—Ç –∏—Å—Ö–æ–¥–Ω—ã–µ IP –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
- **SNAT –ø—Ä–∞–≤–∏–ª–æ** ‚Äî –º–∞—Å–∫–∏—Ä—É–µ—Ç egress-—Ç—Ä–∞—Ñ–∏–∫ –≤ –æ–¥–∏–Ω –≤–Ω–µ—à–Ω–∏–π IP
- **–ü–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª** ‚Äî No-SNAT –≤—ã—à–µ SNAT

---

## Backup –∏ Recovery

### –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
```bash
# T1 Gateway:
# NSX UI ‚Üí Networking ‚Üí Tier-1 Gateways ‚Üí T1-k8s-zeon-dev ‚Üí Export

# NAT Rules:
# NSX UI ‚Üí Networking ‚Üí Tier-1 Gateways ‚Üí T1-k8s-zeon-dev ‚Üí NAT ‚Üí Export

# Segment:
# NSX UI ‚Üí Networking ‚Üí Segments ‚Üí k8s-zeon-dev-segment ‚Üí Export
```

### –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
```bash
# –ò–º–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π –≤ NSX UI:
# Networking ‚Üí Tier-1 Gateways ‚Üí Import
# Networking ‚Üí Segments ‚Üí Import
```

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

**NSX Admin:** `Ayrapetov_es`
**Kubernetes Admin:** `Ayrapetov_es`

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è

| –î–∞—Ç–∞ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –ê–≤—Ç–æ—Ä |
|------|-----------|-------|
| `2025-01-17` | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ NSX-T | `Ayrapetov_es` |
| | | |

---

**–≠—Ç–∞ –ø–∞–ø–∫–∞ ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è —Å–µ—Ç–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ K8s –∫–ª–∞—Å—Ç–µ—Ä–∞.**
**–û–±–Ω–æ–≤–ª—è–π –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ NSX-T!**
