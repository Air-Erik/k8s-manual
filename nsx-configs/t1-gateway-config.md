# T1 Gateway Configuration for Kubernetes Cluster

> **–°—Ç–∞—Ç—É—Å:** üü¢ COMPLETED (–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞)
> **–î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** 2025-01-17
> **–û–ø–µ—Ä–∞—Ç–æ—Ä:** Ayrapetov_es

---

## –û–±–∑–æ—Ä

–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Ñ–∏–∫—Å–∏—Ä—É–µ—Ç **–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é T1 Gateway** –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞.

**T1 Gateway:** `T1-k8s-zeon-dev` ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π Tier-1 Gateway –¥–ª—è –ø–æ–ª–Ω–æ–π –∏–∑–æ–ª—è—Ü–∏–∏ k8s –∫–ª–∞—Å—Ç–µ—Ä–∞ –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö Tanzu –∫–ª–∞—Å—Ç–µ—Ä–æ–≤.

---

## T1 Gateway Information

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—á–∞–Ω–∏—è |
|----------|---------|-----------|
| **T1 Gateway Name** | `T1-k8s-zeon-dev` | –ò–º—è T1 Gateway –≤ NSX-T |
| **Tier-0 Gateway** | `TO-GW` | –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É T0 |
| **Edge Cluster** | `EC-1` | Edge Cluster –¥–ª—è T1 |
| **HA Mode** | `Active-Standby` | –í—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å |
| **Route Advertisement** | `Connected Segments + NAT IPs` | –ê–Ω–æ–Ω—Å –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ T0 |

---

## Route Advertisement Configuration

**–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Route Advertisement –Ω–∞ T1-k8s-zeon-dev:**

| –ù–∞—Å—Ç—Ä–æ–π–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|-----------|---------|------------|
| **All Connected Segments & Service Ports** | `Enabled` | –ê–Ω–æ–Ω—Å —Å–µ–≥–º–µ–Ω—Ç–∞ 10.246.10.0/24 –≤ T0 |
| **All NAT IPs** | `Enabled` | –ê–Ω–æ–Ω—Å SNAT IP 172.16.50.170 –≤ T0 |
| **All LB VIP Routes** | `Disabled` | –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è NSX Load Balancer |
| **All Static Routes** | `Disabled` | –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ –º–∞—Ä—à—Ä—É—Ç—ã –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã |

---

## Connected Segments

| Segment Name | Subnet | Gateway IP | Transport Zone |
|--------------|--------|------------|----------------|
| `k8s-zeon-dev-segment` | `10.246.10.0/24` | `10.246.10.1/24` | `nsx-overlay-transportzone` |

---

## NAT Rules Configuration

**NAT –ø—Ä–∞–≤–∏–ª–∞ –Ω–∞ T1-k8s-zeon-dev (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):**

### 1. No-SNAT –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|
| **Rule Name** | `no_snat_to_internal` |
| **Type** | `No-SNAT` |
| **Source** | `10.246.10.0/24` |
| **Destination** | `Any` |
| **Translated IP** | `N/A` |
| **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** | –î–æ—Å—Ç—É–ø –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º (—Ä–µ–µ—Å—Ç—Ä—ã, CI) –±–µ–∑ NAT |

### 2. No-SNAT –∫ VIP –ø—É–ª—É
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|
| **Rule Name** | `no_snat_to_vips` |
| **Type** | `No-SNAT` |
| **Source** | `10.246.10.0/24` |
| **Destination** | `172.16.50.192/27` |
| **Translated IP** | `N/A` |
| **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** | –î–æ—Å—Ç—É–ø –∫ Ingress VIP –±–µ–∑ hairpin –ø—Ä–æ–±–ª–µ–º |

### 3. SNAT –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|---------|
| **Rule Name** | `snat_to_internet` |
| **Type** | `SNAT` |
| **Source** | `10.246.10.0/24` |
| **Destination** | `Any` |
| **Translated IP** | `172.16.50.170` |
| **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ** | Egress –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ –µ–¥–∏–Ω—ã–π –≤–Ω–µ—à–Ω–∏–π IP |

---

## Gateway Firewall Rules

**Gateway Firewall –Ω–∞ T1-k8s-zeon-dev:**

| Rule | Source | Destination | Service | Action | Status |
|------|--------|-------------|---------|--------|--------|
| **Default** | `Any` | `Any` | `Any` | `Allow` | ‚úÖ Active |

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** Gateway Firewall –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ —Ä–µ–∂–∏–º–µ "Allow All" –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

---

## Routing Table

**–ú–∞—Ä—à—Ä—É—Ç—ã –Ω–∞ T1-k8s-zeon-dev:**

| Destination | Next Hop | Type | Status |
|-------------|----------|------|--------|
| `10.246.10.0/24` | `Local` | `Connected` | ‚úÖ Active |
| `0.0.0.0/0` | `TO-GW` | `Default Route` | ‚úÖ Active |

---

## Connectivity Tests

**–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–Ω–æ—Å—Ç–∏ T1 Gateway:**

| Test | Command | Result | Notes |
|------|---------|--------|-------|
| **T1 ‚Üí T0** | `ping 172.16.50.1` | ‚úÖ Pass | –°–≤—è–∑–Ω–æ—Å—Ç—å —Å T0 uplink |
| **T1 ‚Üí Internet** | `ping 8.8.8.8` | ‚úÖ Pass | –ß–µ—Ä–µ–∑ SNAT 172.16.50.170 |
| **T1 ‚Üí VIP Pool** | `ping 172.16.50.200` | ‚úÖ Pass | No-SNAT —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **T1 ‚Üí Internal** | `ping 172.16.100.1` | ‚úÖ Pass | No-SNAT –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º |

---

## Monitoring and Troubleshooting

### NAT Statistics
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ NAT –ø—Ä–∞–≤–∏–ª –≤ NSX UI:
# Networking ‚Üí Tier-1 Gateways ‚Üí T1-k8s-zeon-dev ‚Üí NAT ‚Üí Rules
# –°–º–æ—Ç—Ä–µ—Ç—å –∫–æ–ª–æ–Ω–∫—É "Hits" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
```

### Route Advertisement Status
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–Ω–æ–Ω—Å–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –≤ NSX UI:
# Networking ‚Üí Tier-0 Gateways ‚Üí TO-GW ‚Üí Routing ‚Üí Routes
# –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã:
# - 10.246.10.0/24 (Connected Segment)
# - 172.16.50.170/32 (NAT IP)
```

### Traceflow
```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ –≤ NSX UI:
# Plan & Troubleshoot ‚Üí Traceflow
# Source: 10.246.10.10 (VM IP)
# Destination: 8.8.8.8
# –û–∂–∏–¥–∞–µ–º—ã–π –ø—É—Ç—å: VM ‚Üí T1 ‚Üí T0 ‚Üí Internet
```

---

## Security Considerations

### –ò–∑–æ–ª—è—Ü–∏—è
- **–û—Ç–¥–µ–ª—å–Ω—ã–π T1** –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–∑–æ–ª—è—Ü–∏—é –æ—Ç Tanzu –∫–ª–∞—Å—Ç–µ—Ä–æ–≤
- **–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –ø–æ–¥—Å–µ—Ç—å** 10.246.10.0/24 –Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ —Å–µ—Ç—è–º–∏
- **–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π SNAT IP** 172.16.50.170 –∏–∑–æ–ª–∏—Ä—É–µ—Ç egress-—Ç—Ä–∞—Ñ–∏–∫

### NAT Security
- **No-SNAT –ø—Ä–∞–≤–∏–ª–∞** –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –∏—Å—Ö–æ–¥–Ω—ã–µ IP –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –≤—ã–∑–æ–≤–æ–≤
- **SNAT –ø—Ä–∞–≤–∏–ª–æ** –º–∞—Å–∫–∏—Ä—É–µ—Ç –≤–µ—Å—å egress-—Ç—Ä–∞—Ñ–∏–∫ –≤ –æ–¥–∏–Ω –≤–Ω–µ—à–Ω–∏–π IP
- **–ü–æ—Ä—è–¥–æ–∫ NAT –ø—Ä–∞–≤–∏–ª** –∫—Ä–∏—Ç–∏—á–µ–Ω: No-SNAT –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—à–µ SNAT

---

## Backup and Recovery

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è T1
```bash
# –≠–∫—Å–ø–æ—Ä—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ T1 Gateway:
# NSX UI ‚Üí Networking ‚Üí Tier-1 Gateways ‚Üí T1-k8s-zeon-dev ‚Üí Export
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤: nsx-configs/t1-k8s-zeon-dev-config.json
```

### NAT Rules Backup
```bash
# –≠–∫—Å–ø–æ—Ä—Ç NAT –ø—Ä–∞–≤–∏–ª:
# NSX UI ‚Üí Networking ‚Üí Tier-1 Gateways ‚Üí T1-k8s-zeon-dev ‚Üí NAT ‚Üí Export
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤: nsx-configs/t1-k8s-zeon-dev-nat-rules.json
```

---

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Kubernetes Deployment

**–≠—Ç–æ—Ç T1 Gateway –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —ç—Ç–∞–ø–∞—Ö:**

1. **–≠—Ç–∞–ø 0.2 (VM Preparation):**
   - Gateway IP 10.246.10.1 –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ VM
   - DNS 172.17.10.3 + 8.8.8.8 –¥–ª—è cloud-init

2. **–≠—Ç–∞–ø 1.1 (Cluster Bootstrap):**
   - –ü–æ–¥—Å–µ—Ç—å 10.246.10.0/24 –¥–ª—è kubeadm init
   - Gateway 10.246.10.1 –¥–ª—è –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏

3. **–≠—Ç–∞–ø 1.4 (MetalLB Setup):**
   - No-SNAT –∫ VIP –ø—É–ª—É 172.16.50.192/27
   - SNAT 172.16.50.170 –¥–ª—è egress

4. **–≠—Ç–∞–ø 1.3 (Storage Setup):**
   - No-SNAT –∫ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º —Å–µ—Ç—è–º –¥–ª—è vCenter access

---

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –∏ –∞–ø–¥–µ–π—Ç—ã

| –î–∞—Ç–∞ | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –ê–≤—Ç–æ—Ä |
|------|-----------|-------|
| `2025-01-17` | –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ T1-k8s-zeon-dev | `Ayrapetov_es` |
| | | |

---

## –ö–æ–Ω—Ç–∞–∫—Ç—ã

**NSX Admin:** `Ayrapetov_es` (–¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –ø–æ NSX-T)
**Kubernetes Admin:** `Ayrapetov_es`

---

**–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ –ø—Ä–∞–≤–¥—ã –¥–ª—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ T1 Gateway k8s –∫–ª–∞—Å—Ç–µ—Ä–∞.**
**–û–±–Ω–æ–≤–ª—è–π –µ–≥–æ –ø—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ T1-k8s-zeon-dev!**
