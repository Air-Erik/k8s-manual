# –°–µ—Ç–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è Kubernetes –Ω–∞ NSX-T: –ß–µ–∫-–ª–∏—Å—Ç

> **–¶–µ–ª—å –¥–æ–∫—É–º–µ–Ω—Ç–∞:** –°–æ–±—Ä–∞—Ç—å –≤—Å–µ —Å–µ—Ç–µ–≤—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è Kubernetes –∫–ª–∞—Å—Ç–µ—Ä–∞ –Ω–∞ NSX-T.
> **–ê—É–¥–∏—Ç–æ—Ä–∏—è:** –û–ø–µ—Ä–∞—Ç–æ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å NSX-T.
> **–í—Ä–µ–º—è —á—Ç–µ–Ω–∏—è:** ~10 –º–∏–Ω—É—Ç.

---

## –û–±–∑–æ—Ä: –ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç NSX-T –¥–ª—è Kubernetes

–ù–∞—à Kubernetes –∫–ª–∞—Å—Ç–µ—Ä —Ç—Ä–µ–±—É–µ—Ç –æ—Ç NSX-T —Å–ª–µ–¥—É—é—â–µ–≥–æ:

1. **–°–µ—Ç—å –¥–ª—è VM** (–Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞) ‚Äî L2 Segment —Å –ø–æ–¥—Å–µ—Ç—å—é
2. **IP-–∞–¥—Ä–µ—Å–∞** –¥–ª—è –Ω–æ–¥, API VIP, MetalLB pool
3. **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é** (Tier-1 ‚Üí Tier-0 ‚Üí Internet)
4. **Firewall –ø—Ä–∞–≤–∏–ª–∞** (DFW) –¥–ª—è —Ç—Ä–∞—Ñ–∏–∫–∞ –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏
5. **–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ ARP** (SpoofGuard) –¥–ª—è VIP –∏ MetalLB
6. **–°–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π MTU** –ø–æ –≤—Å–µ–π —Ü–µ–ø–æ—á–∫–µ
7. **(–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) NAT** –¥–ª—è egress —Ç—Ä–∞—Ñ–∏–∫–∞

–î–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä—ë–º –∫–∞–∂–¥–æ–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ä–æ–±–Ω–æ.

---

## 1. Segment –¥–ª—è k8s-–Ω–æ–¥ ‚úÖ

### –ß—Ç–æ –Ω—É–∂–Ω–æ:

- **–û–¥–∏–Ω L2 Segment** –¥–ª—è **–≤—Å–µ—Ö** –Ω–æ–¥ –∫–ª–∞—Å—Ç–µ—Ä–∞ (control plane + workers)
- Segment –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ **Tier-1 Gateway** (–∫–æ—Ç–æ—Ä—ã–π –∏–º–µ–µ—Ç uplink –∫ Tier-0)

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Segment:

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –ü—Ä–∏–º–µ—Ä |
|----------|-----------|---------|
| **–ò–º—è** | –£–Ω–∏–∫–∞–ª—å–Ω–æ–µ (–Ω–µ –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è —Å Tanzu) | `k8s-nodes-segment` –∏–ª–∏ `VIP-VM` |
| **–ü–æ–¥—Å–µ—Ç—å (CIDR)** | /24 –º–∏–Ω–∏–º—É–º (256 IP, ~250 –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö) | `192.168.100.0/24` |
| **Gateway IP** | –ü–µ—Ä–≤—ã–π IP –ø–æ–¥—Å–µ—Ç–∏ (–Ω–∞ Tier-1) | `192.168.100.1` |
| **DHCP** | –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ (–º–æ–∂–Ω–æ static IP) | Enabled –∏–ª–∏ Disabled |
| **Transport Zone** | –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è TZ | `overlay-tz` (–∏–ª–∏ –∫–∞–∫ —É —Ç–µ–±—è) |
| **Tier-1 Gateway** | –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ Tier-0 | `k8s-tier1` (–∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π) |

### –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] Segment —Å–æ–∑–¥–∞–Ω (–∏–ª–∏ –≤—ã–±—Ä–∞–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π)
- [ ] Segment –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Tier-1 Gateway
- [ ] Tier-1 Gateway –∏–º–µ–µ—Ç –º–∞—Ä—à—Ä—É—Ç –∫ Tier-0
- [ ] –ü–æ–¥—Å–µ—Ç—å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.100.0/24)
- [ ] Gateway IP –¥–æ—Å—Ç—É–ø–µ–Ω (–º–æ–∂–Ω–æ –ø–∏–Ω–≥–æ–≤–∞—Ç—å —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM)

---

## 2. IP-–∞–¥—Ä–µ—Å–∞—Ü–∏—è (–∫—Ä–∏—Ç–∏—á–Ω–æ!) üî¢

### –ü–ª–∞–Ω –≤—ã–¥–µ–ª–µ–Ω–∏—è IP:

–¢–µ–±–µ –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å IP –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö —Ü–µ–ª–µ–π:

| –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –ü—Ä–∏–º–µ—Ä –¥–∏–∞–ø–∞–∑–æ–Ω–∞ |
|------------|-----------|------------------|
| **Control Plane –Ω–æ–¥—ã** | 3 —à—Ç | `192.168.100.10-12` |
| **Worker –Ω–æ–¥—ã** | 2+ (–∑–∞–ø–∞—Å 5+) | `192.168.100.20-30` |
| **API VIP** (kube-vip) | 1 —à—Ç | `192.168.100.100` |
| **MetalLB IP Pool** | 10-20 —à—Ç | `192.168.100.200-220` |
| **–ó–∞–ø–∞—Å** (–¥–ª—è —Ä–æ—Å—Ç–∞) | 20+ | `192.168.100.31-50` |
| **Gateway** | 1 (–∑–∞–Ω—è—Ç Tier-1) | `192.168.100.1` |

**–ò—Ç–æ–≥–æ:** –ú–∏–Ω–∏–º—É–º **40-50 IP** –¥–ª—è –Ω–∞—á–∞–ª–∞ (PoC), **80-100 IP** –¥–ª—è Prod.

### –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] –ü–æ–¥—Å–µ—Ç—å –∏–º–µ–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ IP (–º–∏–Ω–∏–º—É–º /25 = 128 IP, —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è /24 = 256 IP)
- [ ] IP-–ø–ª–∞–Ω –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω (–∫—Ç–æ –∫–∞–∫–æ–π IP –∏—Å–ø–æ–ª—å–∑—É–µ—Ç)
- [ ] IP **–ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è** —Å Tanzu IP Pool
- [ ] IP **–ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞—é—Ç—Å—è** —Å DHCP pool (–µ—Å–ª–∏ DHCP –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
- [ ] API VIP –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º–∏ VM
- [ ] MetalLB pool –∑–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω –∏ —Å–≤–æ–±–æ–¥–µ–Ω
- [ ] DNS –∑–∞–ø–∏—Å–∏ –¥–ª—è API VIP —Å–æ–∑–¥–∞–Ω—ã (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –Ω–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

### –ü—Ä–∏–º–µ—Ä IP-–ø–ª–∞–Ω–∞ (–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–µ—Ç—Å—è –≤ `nsx-configs/segments.md`):

```markdown
## IP Allocation Plan

| IP Range | Purpose | Notes |
|----------|---------|-------|
| 192.168.100.1 | Gateway (Tier-1) | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| 192.168.100.10-12 | Control Plane Nodes | cp-01, cp-02, cp-03 |
| 192.168.100.20-30 | Worker Nodes | w-01, w-02, ... (–∑–∞–ø–∞—Å –¥–æ 10 workers) |
| 192.168.100.100 | API VIP (kube-vip) | k8s-api.example.com |
| 192.168.100.200-220 | MetalLB Pool | –î–ª—è Service LoadBalancer (20 IP) |
| 192.168.100.50-99 | Reserved | –ó–∞–ø–∞—Å –¥–ª—è –±—É–¥—É—â–∏—Ö –Ω–æ–¥ |
```

---

## 3. –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∏ –≤–Ω–µ—à–Ω—è—è —Å–≤—è–∑–Ω–æ—Å—Ç—å üåê

### –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –ü—Ä–æ–≤–µ—Ä–∫–∞ | –ö–æ–º–∞–Ω–¥–∞ |
|-----------|---------|---------|
| **Tier-1 ‚Üí Tier-0** | Uplink —Å—É—â–µ—Å—Ç–≤—É–µ—Ç | NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí Tier-0 Connectivity |
| **Default route** | 0.0.0.0/0 ‚Üí Tier-0 | NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí Routing |
| **Internet egress** | VM –º–æ–∂–µ—Ç –¥–æ—Å—Ç–∞—Ç—å 8.8.8.8 | `ping 8.8.8.8` —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM |
| **DNS resolution** | VM —Ä–µ–∑–æ–ª–≤–∏—Ç –¥–æ–º–µ–Ω—ã | `nslookup google.com` —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM |
| **vCenter –¥–æ—Å—Ç—É–ø–µ–Ω** | –î–ª—è vSphere CSI | `curl -k https://<vcenter-IP>` —Å VM |

### NAT (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω):

- –ï—Å–ª–∏ –ø–æ–¥—Å–µ—Ç—å k8s-–Ω–æ–¥ **–ø—Ä–∏–≤–∞—Ç–Ω–∞—è** (192.168.x.x), –Ω—É–∂–µ–Ω **SNAT** –¥–ª—è egress
- NAT –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –Ω–∞ **Tier-0 –∏–ª–∏ Tier-1 Gateway**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å: NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí NAT ‚Üí SNAT –ø—Ä–∞–≤–∏–ª–æ

### –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] Tier-1 Gateway –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Tier-0
- [ ] Default route –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è VM –≤ —Å–µ–≥–º–µ–Ω—Ç–µ –º–æ–∂–µ—Ç –ø–∏–Ω–≥–æ–≤–∞—Ç—å 8.8.8.8
- [ ] –¢–µ—Å—Ç–æ–≤–∞—è VM –º–æ–∂–µ—Ç —Ä–µ–∑–æ–ª–≤–∏—Ç—å DNS (google.com)
- [ ] SNAT –ø—Ä–∞–≤–∏–ª–æ —Å–æ–∑–¥–∞–Ω–æ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
- [ ] vCenter –¥–æ—Å—Ç—É–ø–µ–Ω —Å VM (–¥–ª—è vSphere CSI)

---

## 4. Distributed Firewall (DFW) Rules üî•

### –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø—Ä–∞–≤–∏–ª–∞:

Kubernetes —Ç—Ä–µ–±—É–µ—Ç **–º–Ω–æ–≥–æ –æ—Ç–∫—Ä—ã—Ç—ã—Ö –ø–æ—Ä—Ç–æ–≤** –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏. –ï—Å–ª–∏ —É —Ç–µ–±—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã DFW –ø—Ä–∞–≤–∏–ª–∞ —Å **default deny**, –Ω—É–∂–Ω–æ **—è–≤–Ω–æ —Ä–∞–∑—Ä–µ—à–∏—Ç—å** —Å–ª–µ–¥—É—é—â–∏–π —Ç—Ä–∞—Ñ–∏–∫:

#### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É "k8s-nodes"

**–û–ø—Ü–∏–∏:**
- –ü–æ IP-–∞–¥—Ä–µ—Å–∞–º (192.168.100.10-30)
- –ü–æ VM tags (vSphere tag "k8s-node")
- –ü–æ –∏–º–µ–Ω–∏ VM (–ø–∞—Ç—Ç–µ—Ä–Ω "k8s-*")

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ü–æ IP (–ø—Ä–æ—â–µ –¥–ª—è PoC), –ø–æ —Ç–µ–≥–∞–º (–ª—É—á—à–µ –¥–ª—è Prod).

#### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤—ã—à–µ deny-all)

| # | Name | Source | Destination | Ports | Action | Priority |
|---|------|--------|-------------|-------|--------|----------|
| 1 | k8s-inter-node | k8s-nodes | k8s-nodes | Any (–∏–ª–∏ —Å–º. –Ω–∏–∂–µ) | Allow | 1000 |
| 2 | k8s-nodeport-ingress | Any | k8s-nodes | 80, 443, 30000-32767 | Allow | 1001 |
| 3 | k8s-egress | k8s-nodes | Any | Any | Allow | 1002 |

**–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ—Ä—Ç–æ–≤ –¥–ª—è –ø—Ä–∞–≤–∏–ª–∞ #1 (–µ—Å–ª–∏ —Ö–æ—á–µ—à—å –±—ã—Ç—å —Ç–æ—á–Ω—ã–º):**

| Port | Protocol | Purpose |
|------|----------|---------|
| 6443 | TCP | Kubernetes API Server |
| 2379-2380 | TCP | etcd client/peer |
| 10250 | TCP | kubelet API |
| 10256 | TCP | kube-proxy healthz |
| 8472 | UDP | Cilium VXLAN (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è) |
| 4240 | TCP | Cilium Health Check |
| 4244 | TCP | Cilium Hubble Server |

**–î–ª—è PoC:** –ú–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å **Any** –º–µ–∂–¥—É k8s-nodes (–ø—Ä–æ—â–µ).
**–î–ª—è Prod:** –û—Ç–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã (–±–µ–∑–æ–ø–∞—Å–Ω–µ–µ).

### –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] –ì—Ä—É–ø–ø–∞ `k8s-nodes` —Å–æ–∑–¥–∞–Ω–∞ –≤ NSX (Security ‚Üí Groups)
- [ ] DFW –ø—Ä–∞–≤–∏–ª–∞ —Å–æ–∑–¥–∞–Ω—ã **–î–û** default deny (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1000-1002)
- [ ] –ü—Ä–∞–≤–∏–ª–æ 1: k8s-nodes ‚Üí k8s-nodes (Any –∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã) = Allow
- [ ] –ü—Ä–∞–≤–∏–ª–æ 2: Any ‚Üí k8s-nodes (80, 443, 30000-32767) = Allow
- [ ] –ü—Ä–∞–≤–∏–ª–æ 3: k8s-nodes ‚Üí Any = Allow (egress)
- [ ] –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ VM (ping, nc, curl)

---

## 5. SpoofGuard Whitelist ‚ö†Ô∏è

### –ü—Ä–æ–±–ª–µ–º–∞:

- **kube-vip** –∞–Ω–æ–Ω—Å–∏—Ä—É–µ—Ç API VIP —á–µ—Ä–µ–∑ gratuitous ARP
- **MetalLB** –∞–Ω–æ–Ω—Å–∏—Ä—É–µ—Ç LoadBalancer IP —á–µ—Ä–µ–∑ gratuitous ARP
- SpoofGuard –≤–∏–¥–∏—Ç, —á—Ç–æ VM –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ARP –¥–ª—è IP, –∫–æ—Ç–æ—Ä—ã–π **–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω –µ–π –≤ vCenter**, –∏ **–±–ª–æ–∫–∏—Ä—É–µ—Ç**

### –†–µ—à–µ–Ω–∏–µ:

**–í–∞—Ä–∏–∞–Ω—Ç A (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è Prod):** –î–æ–±–∞–≤–∏—Ç—å whitelist

- NSX UI ‚Üí Security ‚Üí SpoofGuard ‚Üí Profiles
- –ù–∞–π—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞ k8s-nodes (–∏–ª–∏ —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π)
- –î–æ–±–∞–≤–∏—Ç—å **Allowed IP Addresses**:
  - API VIP (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.100.100)
  - MetalLB pool (–Ω–∞–ø—Ä–∏–º–µ—Ä, 192.168.100.200-220)

**–í–∞—Ä–∏–∞–Ω—Ç B (–ø—Ä–æ—â–µ –¥–ª—è PoC):** –û—Ç–∫–ª—é—á–∏—Ç—å SpoofGuard –Ω–∞ –ø–æ—Ä—Ç–∞—Ö k8s-–Ω–æ–¥

- NSX UI ‚Üí Security ‚Üí SpoofGuard ‚Üí Switching Profiles
- –ù–∞–π—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞ ‚Üí SpoofGuard = **Disabled**

‚ö†Ô∏è **–í–∞—Ä–∏–∞–Ω—Ç B –º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–µ–Ω** (VM –º–æ–≥—É—Ç –ø–æ–¥–º–µ–Ω—è—Ç—å IP), –Ω–æ –ø—Ä–æ—â–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

### –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] SpoofGuard –ø—Ä–æ–≤–µ—Ä–µ–Ω (–≤–∫–ª—é—á—ë–Ω –∏–ª–∏ –≤—ã–∫–ª—é—á–µ–Ω?)
- [ ] –ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω: Whitelist —Å–æ–∑–¥–∞–Ω –¥–ª—è API VIP + MetalLB pool
- [ ] –ï—Å–ª–∏ –æ—Ç–∫–ª—é—á—ë–Ω: –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ (–¥–ª—è Prod –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Å whitelist)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞: –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–π VM –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å secondary IP, –ø–∏–Ω–≥–∞–Ω—É—Ç—å —Å –¥—Ä—É–≥–æ–π VM (–¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å)

---

## 6. MTU End-to-End üìè

### –ü–æ—á–µ–º—É —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ:

- –ù–µ—Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω—ã–π MTU = —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏—è –ø–∞–∫–µ—Ç–æ–≤ = —Ç–∞–π–º–∞—É—Ç—ã, –ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π, –º–µ–¥–ª–µ–Ω–Ω–∞—è —Ä–∞–±–æ—Ç–∞
- NSX overlay –¥–æ–±–∞–≤–ª—è–µ—Ç ~50-100 –±–∞–π—Ç –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (Geneve)
- Cilium VXLAN –¥–æ–±–∞–≤–ª—è–µ—Ç –µ—â—ë ~50 –±–∞–π—Ç

### –¶–µ–ø–æ—á–∫–∞ MTU:

```
Physical Network (Underlay)
  MTU: –æ–±—ã—á–Ω–æ 1600 –∏–ª–∏ 9000 (Jumbo Frames)
       ‚Üì
NSX Transport Node Overlay
  MTU: –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ NSX UI ‚Üí System ‚Üí Fabric ‚Üí Nodes ‚Üí Transport Nodes
  –û–±—ã—á–Ω–æ: 1600 (–µ—Å–ª–∏ underlay 1600+)
       ‚Üì
VM vNIC (Node)
  MTU: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ú–ï–ù–¨–®–ï overlay –Ω–∞ ~100 –±–∞–π—Ç
  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 1500 (–µ—Å–ª–∏ overlay 1600)
       ‚Üì
Cilium CNI (Pod Network)
  MTU: –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ú–ï–ù–¨–®–ï VM –Ω–∞ ~50 –±–∞–π—Ç
  –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 1450 (–µ—Å–ª–∏ VM 1500)
```

### –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] **–ü—Ä–æ–≤–µ—Ä–µ–Ω MTU –Ω–∞ NSX Transport Nodes** (NSX UI ‚Üí System ‚Üí Fabric ‚Üí Nodes ‚Üí Transport Nodes ‚Üí Overlay MTU)
- [ ] **–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω MTU –¥–ª—è VM vNIC** (–æ–±—ã—á–Ω–æ 1500)
- [ ] **–†–∞—Å—Å—á–∏—Ç–∞–Ω MTU –¥–ª—è Cilium** = VM MTU - 50 (–æ–±—ã—á–Ω–æ 1450)
- [ ] **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω MTU** —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ VM:
  ```bash
  # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π MTU –Ω–∞ VM
  ip link show ens192

  # –¢–µ—Å—Ç ping —Å –±–æ–ª—å—à–∏–º –ø–∞–∫–µ—Ç–æ–º (–±–µ–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏)
  ping -M do -s 1400 <IP-–¥—Ä—É–≥–æ–π-VM>

  # –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç, —É–º–µ–Ω—å—à–∞—Ç—å —Ä–∞–∑–º–µ—Ä –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–π–¥—ë—Ç
  ping -M do -s 1200 <IP-–¥—Ä—É–≥–æ–π-VM>
  ```

### –ü—Ä–∏–º–µ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ MTU (–¥–ª—è `nsx-configs/segments.md`):

```markdown
## MTU Configuration

| Layer | MTU | Notes |
|-------|-----|-------|
| NSX Overlay (Transport Nodes) | 1600 | –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ NSX UI |
| VM vNIC (k8s nodes) | 1500 | –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ Ubuntu |
| Cilium CNI (Pod network) | 1450 | –ó–∞–¥–∞—ë—Ç—Å—è –≤ Cilium values.yaml |

**–ü—Ä–æ–≤–µ—Ä–∫–∞:** `ping -M do -s 1400 <node-IP>` –ø—Ä–æ—Ö–æ–¥–∏—Ç –±–µ–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏ ‚úÖ
```

---

## 7. DNS Servers üåê

### –ß—Ç–æ –Ω—É–∂–Ω–æ:

- VM-–Ω–æ–¥—ã –¥–æ–ª–∂–Ω—ã —Ä–µ–∑–æ–ª–≤–∏—Ç—å –¥–æ–º–µ–Ω—ã:
  - `apt.kubernetes.io` (–¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ kubeadm/kubelet)
  - `registry.k8s.io`, `ghcr.io`, `docker.io` (–¥–ª—è –æ–±—Ä–∞–∑–æ–≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤)
  - vCenter FQDN (–¥–ª—è vSphere CSI)
  - –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –¥–æ–º–µ–Ω—ã (–µ—Å–ª–∏ –µ—Å—Ç—å)

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ DNS:

**–í–∞—Ä–∏–∞–Ω—Ç A:** –ß–µ—Ä–µ–∑ DHCP (–µ—Å–ª–∏ DHCP –≤–∫–ª—é—á–µ–Ω –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–µ)
- NSX –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞—ë—Ç DNS servers –∏–∑ DHCP –∫–æ–Ω—Ñ–∏–≥–∞

**–í–∞—Ä–∏–∞–Ω—Ç B:** –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏ –≤ Ubuntu
- `/etc/netplan/` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–ª–∏ cloud-init

### –ß–µ–∫-–ª–∏—Å—Ç:

- [ ] DNS servers –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã (–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–µ 8.8.8.8, 8.8.4.4)
- [ ] DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ NSX Segment (–µ—Å–ª–∏ DHCP) –∏–ª–∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è —Ä—É—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM:
  ```bash
  nslookup google.com
  nslookup apt.kubernetes.io
  nslookup <vcenter-fqdn>
  ```

---

## 8. –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è (–¥–ª—è Prod)

### 8.1. NTP (Network Time Protocol)

- –í—Å–µ –Ω–æ–¥—ã –¥–æ–ª–∂–Ω—ã –∏–º–µ—Ç—å **—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è** (–∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è etcd, certificates)
- –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –≤ Ubuntu —á–µ—Ä–µ–∑ `systemd-timesyncd` –∏–ª–∏ `chrony`
- NTP servers: –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–µ (pool.ntp.org)

### 8.2. Proxy (–µ—Å–ª–∏ –µ—Å—Ç—å)

- –ï—Å–ª–∏ egress –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —á–µ—Ä–µ–∑ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π proxy:
  - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `HTTP_PROXY`, `HTTPS_PROXY`, `NO_PROXY` –Ω–∞ –Ω–æ–¥–∞—Ö
  - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å containerd –¥–ª—è —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ proxy

### 8.3. –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π CA)

- –ï—Å–ª–∏ vCenter –∏—Å–ø–æ–ª—å–∑—É–µ—Ç self-signed cert –∏–ª–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π CA:
  - –î–æ–±–∞–≤–∏—Ç—å CA cert –≤ trust store Ubuntu (`/usr/local/share/ca-certificates/`)

---

## –°–≤–æ–¥–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞: –ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç NSX-T

| –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ | –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ? | –ó–∞–¥–∞—á–∞ | –ü—Ä–æ–≤–µ—Ä–∫–∞ |
|-----------|-------------|--------|---------|
| **Segment –¥–ª—è k8s-–Ω–æ–¥** | ‚úÖ –î–∞ | –°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π | –°–µ–≥–º–µ–Ω—Ç –≤–∏–¥–µ–Ω –≤ vSphere –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ VM |
| **IP-–ø–ª–∞–Ω** | ‚úÖ –î–∞ | –ó–∞—Ä–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞—Ç—å IP (–Ω–æ–¥—ã, VIP, MetalLB) | –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ –≤ `nsx-configs/segments.md` |
| **Tier-1 ‚Üí Tier-0** | ‚úÖ –î–∞ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å uplink | –¢–µ—Å—Ç–æ–≤–∞—è VM –ø–∏–Ω–≥—É–µ—Ç 8.8.8.8 |
| **DFW Rules** | ‚úÖ –î–∞ | –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É –∏ –ø—Ä–∞–≤–∏–ª–∞ | –¢–µ—Å—Ç–æ–≤—ã–µ VM –ø–∏–Ω–≥—É—é—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞, `nc -zv` –Ω–∞ –ø–æ—Ä—Ç—ã OK |
| **SpoofGuard Whitelist** | ‚úÖ –î–∞ | –î–æ–±–∞–≤–∏—Ç—å VIP + MetalLB –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å | Gratuitous ARP –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è |
| **MTU –ø—Ä–æ–≤–µ—Ä–µ–Ω** | ‚úÖ –î–∞ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å NSX overlay, —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –¥–ª—è VM/Cilium | `ping -M do -s 1400` –ø—Ä–æ—Ö–æ–¥–∏—Ç |
| **DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω** | ‚úÖ –î–∞ | –£–∫–∞–∑–∞—Ç—å DNS servers | `nslookup google.com` —Ä–∞–±–æ—Ç–∞–µ—Ç |
| **NAT (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)** | ‚ö†Ô∏è –ó–∞–≤–∏—Å–∏—Ç | –°–æ–∑–¥–∞—Ç—å SNAT –¥–ª—è egress | VM –¥–æ—Å—Ç–∞—é—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç |
| **NTP** | üü° –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å NTP –Ω–∞ VM | `timedatectl` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç sync |
| **Proxy** | üü° –ï—Å–ª–∏ –µ—Å—Ç—å | –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è | `curl` —á–µ—Ä–µ–∑ proxy —Ä–∞–±–æ—Ç–∞–µ—Ç |

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–¢–µ–ø–µ—Ä—å —É —Ç–µ–±—è –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π! üéâ

–°–ª–µ–¥—É—é—â–∏–π –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî **–æ–ø—Ä–æ—Å–Ω–∏–∫** –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–π NSX-T –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –Ø —Å–æ–∑–¥–∞–º –µ–≥–æ —Å–µ–π—á–∞—Å, –∏ —Ç—ã –∑–∞–ø–æ–ª–Ω–∏—à—å –æ—Ç–≤–µ—Ç—ã, –∏–∑—É—á–∞—è NSX UI.

üëâ **–ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –≠—Ç–∞–ø—É 2: –ò—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

–Ø —Å–æ–∑–¥–∞–º –¥–æ–∫—É–º–µ–Ω—Ç `04-current-config-questionnaire.md` –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å! üìã
