# –ü–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–µ–≥–º–µ–Ω—Ç–∞ k8s-nodes

> **–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π NSX-T —Å–µ–≥–º–µ–Ω—Ç –¥–ª—è Kubernetes –Ω–æ–¥
> **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** ~65 –º–∏–Ω—É—Ç
> **–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:** –ü—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –≤ NSX Manager UI

---

## –û–±–∑–æ—Ä –∑–∞–¥–∞—á–∏

–ú—ã —Å–æ–∑–¥–∞–¥–∏–º:
1. ‚úÖ –ù–æ–≤—ã–π Segment `k8s-nodes-segment` (172.16.50.0/24)
2. ‚úÖ Tier-1 Gateway Interface –¥–ª—è Gateway IP
3. ‚úÖ DFW Group `k8s-nodes`
4. ‚úÖ DFW Rules –¥–ª—è K8s —Ç—Ä–∞—Ñ–∏–∫–∞
5. ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—é —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ VM

---

## –ß–ê–°–¢–¨ 1: –°–æ–∑–¥–∞–Ω–∏–µ Segment (15 –º–∏–Ω—É—Ç)

### –®–∞–≥ 1.1: –û—Ç–∫—Ä—ã—Ç—å NSX Manager UI

```
URL: https://<your-nsx-manager-IP>
Login: admin (–∏–ª–∏ —Ç–≤–æ–π account)
```

---

### –®–∞–≥ 1.2: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π Segment

**–ü—É—Ç—å:** `NSX UI ‚Üí Networking ‚Üí Segments ‚Üí ADD SEGMENT`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ | –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π |
|------|---------|-------------|
| **Segment Name** | `k8s-nodes-segment` | –ü–æ–Ω—è—Ç–Ω–æ–µ –∏–º—è |
| **Connected Gateway** | `T1-GW-1` | –°—É—â–µ—Å—Ç–≤—É—é—â–∏–π Tier-1 |
| **Transport Zone** | `nsx-overlay-transportzone` | –ö–∞–∫ —É VIP-VM |
| **Subnets** | `172.16.50.1/24` | Gateway IP + CIDR |

**–î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏:**

1. –ö–ª–∏–∫–Ω–∏ **"ADD SEGMENT"** (—Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ —Å–ø—Ä–∞–≤–∞ —Å–≤–µ—Ä—Ö—É)

2. **General Information:**
   - **Segment Name:** `k8s-nodes-segment`
   - **Connected Gateway:** –í—ã–±–µ—Ä–∏ –∏–∑ dropdown: `T1-GW-1`
   - **Transport Zone:** –í—ã–±–µ—Ä–∏: `nsx-overlay-transportzone | Overlay`

3. **Subnets:**
   - –ö–ª–∏–∫–Ω–∏ **"SET SUBNETS"**
   - **Gateway IP Address:** `172.16.50.1/24`
   - (NSX –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–∞ Tier-1)

4. **Advanced Configuration** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å):
   - **DHCP Config:** `None` (–Ω–µ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º, –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å static IP)
   - **Segment Profiles:** –û—Å—Ç–∞–≤—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

5. **–ö–ª–∏–∫–Ω–∏ "SAVE"**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- Segment `k8s-nodes-segment` –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ
- –°—Ç–∞—Ç—É—Å: `Success` (–∑–µ–ª—ë–Ω–∞—è –≥–∞–ª–æ—á–∫–∞)
- Connected Gateway: `T1-GW-1`

---

### –®–∞–≥ 1.3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ vCenter

**–ü—É—Ç—å:** `vCenter UI ‚Üí Networking ‚Üí Segments`

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
- ‚úÖ Segment `k8s-nodes-segment` –ø–æ—è–≤–∏–ª—Å—è –≤ —Å–ø–∏—Å–∫–µ
- ‚úÖ –ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —ç—Ç–æ—Ç —Å–µ–≥–º–µ–Ω—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ VM (–ø—Ä–æ–≤–µ—Ä–∏–º –ø–æ–∑–∂–µ)

---

## –ß–ê–°–¢–¨ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ Tier-1 Gateway Interface (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 2.1: –û—Ç–∫—Ä—ã—Ç—å Tier-1 Gateway

**–ü—É—Ç—å:** `NSX UI ‚Üí Networking ‚Üí Tier-1 Gateways ‚Üí T1-GW-1`

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**

1. **Tier-0 Connectivity:**
   - –í —Å–µ–∫—Ü–∏–∏ "Tier-0 Gateway" –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å: `T0-GW`
   - –°—Ç–∞—Ç—É—Å: `Connected` ‚úÖ

2. **Interfaces:**
   - –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **"Interfaces"**
   - –î–æ–ª–∂–µ–Ω –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
     - Name: `k8s-nodes-segment`
     - Type: `Segment`
     - IP Address: `172.16.50.1/24`
     - Status: `Success`

**–ï—Å–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –Ω–µ –ø–æ—è–≤–∏–ª—Å—è:**
- –ü–æ–¥–æ–∂–¥–∏ 1-2 –º–∏–Ω—É—Ç—ã (NSX —Å–æ–∑–¥–∞—ë—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ)
- –û–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
- –ï—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ—Ç ‚Üí –≤–µ—Ä–Ω–∏—Å—å –∫ –®–∞–≥—É 1.2, –ø—Ä–æ–≤–µ—Ä—å "Subnets" –Ω–∞—Å—Ç—Ä–æ–π–∫—É

---

## –ß–ê–°–¢–¨ 3: –°–æ–∑–¥–∞–Ω–∏–µ DFW Group –¥–ª—è K8s (5 –º–∏–Ω—É—Ç)

### –®–∞–≥ 3.1: –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–ø–ø—É k8s-nodes

**–ü—É—Ç—å:** `NSX UI ‚Üí Inventory ‚Üí Groups ‚Üí ADD GROUP`

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**

| –ü–æ–ª–µ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|------|---------|
| **Group Name** | `k8s-nodes` |
| **Description** | `Kubernetes cluster nodes` |
| **Membership Criteria** | IP Address |
| **IP Address** | `172.16.50.0/24` |

**–î–µ—Ç–∞–ª—å–Ω—ã–µ —à–∞–≥–∏:**

1. –ö–ª–∏–∫–Ω–∏ **"ADD GROUP"**

2. **General:**
   - **Name:** `k8s-nodes`
   - **Description:** `Kubernetes cluster nodes (all control plane and workers)`

3. **Compute Members:**
   - **Member Type:** –í—ã–±–µ—Ä–∏ `IP Address`
   - –ö–ª–∏–∫–Ω–∏ **"SET MEMBERS"**

4. **IP Address Membership:**
   - –ö–ª–∏–∫–Ω–∏ **"Add Criteria"**
   - **Criteria:** `IP Address`
   - **Operator:** `Equals`
   - **Value:** `172.16.50.0/24`
   - –ö–ª–∏–∫–Ω–∏ **"APPLY"**

5. **–ö–ª–∏–∫–Ω–∏ "SAVE"**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ì—Ä—É–ø–ø–∞ `k8s-nodes` —Å–æ–∑–¥–∞–Ω–∞
- Membership: `IP Address = 172.16.50.0/24`
- VM Count: `0` (–ø–æ–∫–∞ –Ω–µ—Ç VM –≤ —ç—Ç–æ–º —Å–µ–≥–º–µ–Ω—Ç–µ)

---

## –ß–ê–°–¢–¨ 4: –°–æ–∑–¥–∞–Ω–∏–µ DFW Rules –¥–ª—è K8s (10 –º–∏–Ω—É—Ç)

### –®–∞–≥ 4.1: –û—Ç–∫—Ä—ã—Ç—å Distributed Firewall

**–ü—É—Ç—å:** `NSX UI ‚Üí Security ‚Üí Distributed Firewall`

**–ß—Ç–æ –≤–∏–¥–∏—à—å:**
- –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–π (–¥–ª—è Tanzu/NCP)
- Default Rules (NDP, DHCP, Layer3)

---

### –®–∞–≥ 4.2: –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Å–µ–∫—Ü–∏—é –¥–ª—è K8s

**–ó–∞—á–µ–º:** –ß—Ç–æ–±—ã –ø—Ä–∞–≤–∏–ª–∞ K8s –±—ã–ª–∏ –æ—Ç–¥–µ–ª—å–Ω–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ –≥–¥–µ –æ–Ω–∏.

**–®–∞–≥–∏:**

1. –í —Å–ø–∏—Å–∫–µ –ø—Ä–∞–≤–∏–ª, –Ω–∞–π–¥–∏ –º–µ—Å—Ç–æ **–ü–ï–†–ï–î** –¥–µ—Ñ–æ–ª—Ç–Ω—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏ (Default Layer3 Rule)
2. –ö–ª–∏–∫–Ω–∏ **"ADD POLICY"** (–∏–ª–∏ "ADD SECTION" –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–µ—Ä—Å–∏–∏ NSX UI)
3. **Name:** `Kubernetes Cluster (k8s-nodes)`
4. **Applied To:** `k8s-nodes` (–≥—Ä—É–ø–ø–∞, –∫–æ—Ç–æ—Ä—É—é –º—ã —Å–æ–∑–¥–∞–ª–∏)
5. **–ö–ª–∏–∫–Ω–∏ "SAVE"**

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ù–æ–≤–∞—è –ø—É—Å—Ç–∞—è —Å–µ–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞.

---

### –®–∞–≥ 4.3: –°–æ–∑–¥–∞—Ç—å Rule 1 ‚Äî Inter-Node Communication

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞–∑—Ä–µ—à–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É K8s –Ω–æ–¥–∞–º–∏ (API, etcd, kubelet, CNI).

**–®–∞–≥–∏:**

1. –í —Å–µ–∫—Ü–∏–∏ "Kubernetes Cluster", –∫–ª–∏–∫–Ω–∏ **"ADD RULE"**

2. **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
   - **Name:** `k8s-inter-node-allow`
   - **Sources:** `k8s-nodes` (–≥—Ä—É–ø–ø–∞)
   - **Destinations:** `k8s-nodes` (–≥—Ä—É–ø–ø–∞)
   - **Services:** `Any` (–∏–ª–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã, —Å–º. –Ω–∏–∂–µ)
   - **Profiles:** `None`
   - **Action:** `Allow`
   - **Applied To:** `k8s-nodes`

3. **–ö–ª–∏–∫–Ω–∏ "PUBLISH"** (–∏–ª–∏ "SAVE")

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ (–±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –¥–ª—è Prod):**

–í–º–µ—Å—Ç–æ `Services: Any`, —Å–æ–∑–¥–∞–π Service Group —Å –ø–æ—Ä—Ç–∞–º–∏:
- TCP 6443 (Kubernetes API)
- TCP 2379-2380 (etcd)
- TCP 10250 (kubelet)
- TCP 4240 (Cilium Health)
- UDP 8472 (Cilium VXLAN)
- TCP 30000-32767 (NodePort)

**–î–ª—è PoC:** –ò—Å–ø–æ–ª—å–∑—É–π `Any` (–ø—Ä–æ—â–µ). **–î–ª—è Prod:** –ò—Å–ø–æ–ª—å–∑—É–π –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –ø–æ—Ä—Ç—ã.

---

### –®–∞–≥ 4.4: –°–æ–∑–¥–∞—Ç—å Rule 2 ‚Äî Ingress (NodePort, Ingress Controller)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞–∑—Ä–µ—à–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π —Ç—Ä–∞—Ñ–∏–∫ –∫ K8s —Å–µ—Ä–≤–∏—Å–∞–º.

**–®–∞–≥–∏:**

1. –ö–ª–∏–∫–Ω–∏ **"ADD RULE"** (–≤ —Ç–æ–π –∂–µ —Å–µ–∫—Ü–∏–∏)

2. **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
   - **Name:** `k8s-ingress-allow`
   - **Sources:** `Any`
   - **Destinations:** `k8s-nodes`
   - **Services:**
     - HTTP (80)
     - HTTPS (443)
     - NodePort Range: 30000-32767 (–µ—Å–ª–∏ –Ω–µ—Ç –≥–æ—Ç–æ–≤–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞, —Å–æ–∑–¥–∞–π: `TCP 30000-32767`)
   - **Action:** `Allow`
   - **Applied To:** `k8s-nodes`

3. **–ö–ª–∏–∫–Ω–∏ "PUBLISH"**

**–ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å NodePort Service (–µ—Å–ª–∏ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ):**
- NSX UI ‚Üí Inventory ‚Üí Services ‚Üí ADD SERVICE
- Name: `NodePort-Range`
- Service Type: `TCP`
- Source Ports: `Any`
- Destination Ports: `30000-32767`
- SAVE

---

### –®–∞–≥ 4.5: –°–æ–∑–¥–∞—Ç—å Rule 3 ‚Äî Egress (Internet, Repos, vCenter)

**–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –†–∞–∑—Ä–µ—à–∏—Ç—å K8s –Ω–æ–¥–∞–º —Ö–æ–¥–∏—Ç—å –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç (apt, docker registry, vCenter API).

**–®–∞–≥–∏:**

1. –ö–ª–∏–∫–Ω–∏ **"ADD RULE"**

2. **–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:**
   - **Name:** `k8s-egress-allow`
   - **Sources:** `k8s-nodes`
   - **Destinations:** `Any`
   - **Services:** `Any`
   - **Action:** `Allow`
   - **Applied To:** `k8s-nodes`

3. **–ö–ª–∏–∫–Ω–∏ "PUBLISH"**

---

### –®–∞–≥ 4.6: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª

**–í–∞–∂–Ω–æ:** –ü—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–í–´–®–ï** –¥–µ—Ñ–æ–ª—Ç–Ω—ã—Ö deny-–ø—Ä–∞–≤–∏–ª.

**–ü–æ—Ä—è–¥–æ–∫ (—Å–≤–µ—Ä—Ö—É –≤–Ω–∏–∑):**
```
1. Kubernetes Cluster (k8s-nodes) ‚Üê –ù–∞—à–∞ —Å–µ–∫—Ü–∏—è
   - k8s-inter-node-allow
   - k8s-ingress-allow
   - k8s-egress-allow
2. ds-domain-... (Tanzu/NCP –ø—Ä–∞–≤–∏–ª–∞)
3. Default Rule NDP
4. Default Rule DHCP
5. Default Layer3 Rule (Drop)
```

**–ï—Å–ª–∏ –ø–æ—Ä—è–¥–æ–∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π:**
- –ò—Å–ø–æ–ª—å–∑—É–π —Å—Ç—Ä–µ–ª–∫–∏ **‚Üë‚Üì** (Move Up/Down) –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ —Å–µ–∫—Ü–∏–π

---

## –ß–ê–°–¢–¨ 5: –í–∞–ª–∏–¥–∞—Ü–∏—è —Å —Ç–µ—Å—Ç–æ–≤—ã–º–∏ VM (30 –º–∏–Ω—É—Ç)

### –®–∞–≥ 5.1: –°–æ–∑–¥–∞—Ç—å 2 —Ç–µ—Å—Ç–æ–≤—ã–µ VM

**–í vCenter:**

1. **VM 1:**
   - Name: `k8s-test-01`
   - OS: Ubuntu 22.04 –∏–ª–∏ 24.04 (–ª—é–±–æ–π Linux)
   - vCPU: 1
   - RAM: 2 GB
   - Disk: 20 GB
   - Network: `k8s-nodes-segment` ‚Üê **–í–ê–ñ–ù–û!**
   - IP: **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π `172.16.50.10`** (–Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤ Ubuntu –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è)

2. **VM 2:**
   - Name: `k8s-test-02`
   - (—Ç–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
   - Network: `k8s-nodes-segment`
   - IP: **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π `172.16.50.11`**

**–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ IP –≤ Ubuntu:**

```bash
# –ù–∞ –∫–∞–∂–¥–æ–π VM –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞:

# –£–∑–Ω–∞—Ç—å –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
ip link show

# –û–±—ã—á–Ω–æ: ens192 –∏–ª–∏ eth0
# –°–æ–∑–¥–∞—Ç—å netplan –∫–æ–Ω—Ñ–∏–≥:
sudo nano /etc/netplan/01-netcfg.yaml

# –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è VM 1 (172.16.50.10):
network:
  version: 2
  ethernets:
    ens192:  # –ò–∑–º–µ–Ω–∏ –Ω–∞ —Ç–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
      dhcp4: no
      addresses:
        - 172.16.50.10/24
      routes:
        - to: default
          via: 172.16.50.1
      nameservers:
        addresses:
          - 8.8.8.8
          - 8.8.4.4

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å:
sudo netplan apply

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å:
ip addr show ens192
```

(–î–ª—è VM 2 –∏—Å–ø–æ–ª—å–∑—É–π `172.16.50.11`)

---

### –®–∞–≥ 5.2: –¢–µ—Å—Ç 1 ‚Äî Ping Gateway

**–ù–∞ VM 1:**

```bash
ping 172.16.50.1

# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ø–∏–Ω–≥–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
# PING 172.16.50.1 56(84) bytes of data.
# 64 bytes from 172.16.50.1: icmp_seq=1 ttl=64 time=0.5 ms
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Pass / ‚ùå Fail

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ VM –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ —Å–µ–≥–º–µ–Ω—Ç—É `k8s-nodes-segment` (vCenter ‚Üí VM ‚Üí Network Adapter)
- –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π IP –≤ Ubuntu: `ip addr show`
- –ü—Ä–æ–≤–µ—Ä—å Tier-1 Interface: NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí T1-GW-1 ‚Üí Interfaces

---

### –®–∞–≥ 5.3: –¢–µ—Å—Ç 2 ‚Äî Ping between VMs

**–ù–∞ VM 1:**

```bash
ping 172.16.50.11

# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ø–∏–Ω–≥–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Pass / ‚ùå Fail

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å DFW Rule 1 (`k8s-inter-node-allow`)
- NSX UI ‚Üí Security ‚Üí Distributed Firewall ‚Üí –ø—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø—Ä–∞–≤–∏–ª–æ **Published** –∏ **Applied**
- –ü—Ä–æ–≤–µ—Ä—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª (k8s –ø—Ä–∞–≤–∏–ª–∞ –í–´–®–ï default deny)

---

### –®–∞–≥ 5.4: –¢–µ—Å—Ç 3 ‚Äî Ping Internet

**–ù–∞ VM 1:**

```bash
ping 8.8.8.8

# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ø–∏–Ω–≥–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Pass / ‚ùå Fail

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å DFW Rule 3 (`k8s-egress-allow`)
- –ü—Ä–æ–≤–µ—Ä—å Tier-1 ‚Üí Tier-0 connectivity (NSX UI ‚Üí Tier-1 ‚Üí T1-GW-1 ‚Üí Tier-0 Gateway = T0-GW)
- –ü—Ä–æ–≤–µ—Ä—å default route –Ω–∞ VM: `ip route show` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `default via 172.16.50.1`)

---

### –®–∞–≥ 5.5: –¢–µ—Å—Ç 4 ‚Äî DNS Resolution

**–ù–∞ VM 1:**

```bash
nslookup google.com

# –û–∂–∏–¥–∞–µ—Ç—Å—è: –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç IP-–∞–¥—Ä–µ—Å–∞
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Pass / ‚ùå Fail

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å DNS –≤ netplan (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å 8.8.8.8, 8.8.4.4)
- –ü—Ä–æ–≤–µ—Ä—å `/etc/resolv.conf`: `cat /etc/resolv.conf`
- –ü—Ä–æ–≤–µ—Ä—å DFW: egress –¥–æ–ª–∂–µ–Ω —Ä–∞–∑—Ä–µ—à–∞—Ç—å UDP 53 (DNS)

---

### –®–∞–≥ 5.6: –¢–µ—Å—Ç 5 ‚Äî MTU Check

**–ù–∞ VM 1:**

```bash
# –¢–µ—Å—Ç —Å –±–æ–ª—å—à–∏–º –ø–∞–∫–µ—Ç–æ–º (–±–µ–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏)
ping -M do -s 1400 172.16.50.11

# –û–∂–∏–¥–∞–µ—Ç—Å—è: –ø–∏–Ω–≥–∏ –ø—Ä–æ—Ö–æ–¥—è—Ç
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Pass / ‚ùå Fail

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- MTU —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π –¥–ª—è overlay
- –£–º–µ–Ω—å—à–∏ MTU –Ω–∞ VM: `sudo ip link set dev ens192 mtu 1450`
- –ü–æ–≤—Ç–æ—Ä–∏ —Ç–µ—Å—Ç —Å `-s 1200`

**–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä—É–π —Ä–∞–±–æ—á–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ MTU** (–¥–ª—è Cilium –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏).

---

### –®–∞–≥ 5.7: –¢–µ—Å—Ç 6 ‚Äî vCenter Access

**–ù–∞ VM 1:**

```bash
# –ó–∞–º–µ–Ω–∏ <vcenter-IP> –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π IP vCenter
curl -k https://<vcenter-IP>

# –û–∂–∏–¥–∞–µ—Ç—Å—è: HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ JSON (–Ω–µ timeout)
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Pass / ‚ùå Fail

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ü—Ä–æ–≤–µ—Ä—å egress DFW rule
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ vCenter –¥–æ—Å—Ç—É–ø–µ–Ω: `ping <vcenter-IP>`

---

### –®–∞–≥ 5.8: –¢–µ—Å—Ç 7 ‚Äî Gratuitous ARP (SpoofGuard)

**–≠—Ç–æ—Ç —Ç–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–±–ª–æ–∫–∏—Ä—É–µ—Ç –ª–∏ SpoofGuard kube-vip/MetalLB ARP.**

**–ù–∞ VM 1:**

```bash
# –î–æ–±–∞–≤–∏—Ç—å secondary IP (–∫–∞–∫ –±—É–¥–µ—Ç –¥–µ–ª–∞—Ç—å kube-vip)
sudo ip addr add 172.16.50.100/24 dev ens192

# –û—Ç–ø—Ä–∞–≤–∏—Ç—å gratuitous ARP
sudo arping -c 3 -A -I ens192 172.16.50.100
```

**–ù–∞ VM 2:**

```bash
# –ü–∏–Ω–≥–∞–Ω—É—Ç—å VIP
ping 172.16.50.100

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ARP-—Ç–∞–±–ª–∏—Ü—É
arp -n | grep 172.16.50.100
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å MAC-–∞–¥—Ä–µ—Å VM 1
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ Pass (VIP –ø–∏–Ω–≥—É–µ—Ç—Å—è) / ‚ùå Fail (timeout)

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- SpoofGuard –±–ª–æ–∫–∏—Ä—É–µ—Ç!
- –ù—É–∂–Ω–æ –∏—Å–∫–∞—Ç—å SpoofGuard –≤ NSX UI –∏ –¥–æ–±–∞–≤–ª—è—Ç—å whitelist
- –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å SpoofGuard –¥–ª—è k8s-nodes —Å–µ–≥–º–µ–Ω—Ç–∞

**–ü–æ—Å–ª–µ —Ç–µ—Å—Ç–∞ –æ—á–∏—Å—Ç–∏:**

```bash
# –ù–∞ VM 1:
sudo ip addr del 172.16.50.100/24 dev ens192
```

---

### –®–∞–≥ 5.9: –ò—Ç–æ–≥–æ–≤–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–ß–µ–∫-–ª–∏—Å—Ç:**

- ‚úÖ Gateway –ø–∏–Ω–≥—É–µ—Ç—Å—è (172.16.50.1)
- ‚úÖ Ping –º–µ–∂–¥—É VM (172.16.50.10 ‚Üî 172.16.50.11)
- ‚úÖ Ping Internet (8.8.8.8)
- ‚úÖ DNS —Ä–∞–±–æ—Ç–∞–µ—Ç (nslookup google.com)
- ‚úÖ MTU –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (ping -M do -s 1400 –ø—Ä–æ—Ö–æ–¥–∏—Ç)
- ‚úÖ vCenter –¥–æ—Å—Ç—É–ø–µ–Ω
- ‚úÖ Gratuitous ARP —Ä–∞–±–æ—Ç–∞–µ—Ç (SpoofGuard –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç)

**–ï—Å–ª–∏ –í–°–ï —Ç–µ—Å—Ç—ã ‚úÖ ‚Üí –ì–û–¢–û–í–û! –ú–æ–∂–Ω–æ —É–¥–∞–ª—è—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ VM –∏ –Ω–∞—á–∏–Ω–∞—Ç—å deploy K8s –Ω–æ–¥.**

---

## –ß–ê–°–¢–¨ 6: –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (10 –º–∏–Ω—É—Ç)

### –®–∞–≥ 6.1: –ó–∞–ø–æ–ª–Ω–∏—Ç—å nsx-configs/segments.md

**–û—Ç–∫—Ä–æ–π:** `nsx-configs/segments.md`

**–ó–∞–ø–æ–ª–Ω–∏ —Å–µ–∫—Ü–∏–∏:**
- Segment Information (–∏–º—è, –ø–æ–¥—Å–µ—Ç—å, gateway, Tier-1)
- IP Allocation Plan (—Ç–∞–±–ª–∏—Ü–∞ —Å IP-–∞–¥—Ä–µ—Å–∞–º–∏)
- MTU Configuration (–∑–Ω–∞—á–µ–Ω–∏—è –∏–∑ —Ç–µ—Å—Ç–æ–≤)
- DNS Configuration (8.8.8.8, 8.8.4.4 –∏–ª–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ)
- DFW Rules (—Å—Ç–∞—Ç—É—Å: –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã, —Å—Å—ã–ª–∫–∞ –Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç)
- SpoofGuard (—Å—Ç–∞—Ç—É—Å: –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç / –Ω–∞—Å—Ç—Ä–æ–µ–Ω whitelist)
- Validation (–≤—Å–µ —á–µ–∫-–ª–∏—Å—Ç—ã ‚úÖ)

---

### –®–∞–≥ 6.2: (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –≠–∫—Å–ø–æ—Ä—Ç DFW Rules

**–ï—Å–ª–∏ —Ö–æ—á–µ—à—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å DFW –ø—Ä–∞–≤–∏–ª–∞ –∫–∞–∫ JSON:**

**–ü—É—Ç—å:** `NSX UI ‚Üí Security ‚Üí Distributed Firewall ‚Üí Export`

**–°–æ—Ö—Ä–∞–Ω–∏ —Ñ–∞–π–ª –∫–∞–∫:** `nsx-configs/dfw-rules-k8s.json`

---

### –®–∞–≥ 6.3: (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –°–∫—Ä–∏–Ω—à–æ—Ç—ã

**–°–¥–µ–ª–∞–π —Å–∫—Ä–∏–Ω—à–æ—Ç—ã:**
1. NSX UI ‚Üí Networking ‚Üí Segments ‚Üí k8s-nodes-segment (–¥–µ—Ç–∞–ª–∏)
2. NSX UI ‚Üí Security ‚Üí Distributed Firewall (–ø—Ä–∞–≤–∏–ª–∞ k8s)
3. NSX UI ‚Üí Inventory ‚Üí Groups ‚Üí k8s-nodes (—á–ª–µ–Ω—Å—Ç–≤–æ)

**–°–æ—Ö—Ä–∞–Ω–∏ –≤:** `research/nsx-analysis/screenshots/`

---

## Troubleshooting (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

### –ü—Ä–æ–±–ª–µ–º–∞: Segment –Ω–µ –ø–æ—è–≤–∏–ª—Å—è –≤ vCenter

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–¥–æ–∂–¥–∏ 2-3 –º–∏–Ω—É—Ç—ã (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è NSX ‚Üí vCenter)
- –û–±–Ω–æ–≤–∏ —Å–ø–∏—Å–æ–∫ –≤ vCenter (F5)
- –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ NSX Compute Manager –¥–æ–±–∞–≤–ª–µ–Ω: NSX UI ‚Üí System ‚Üí Fabric ‚Üí Compute Managers
- –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å —Å–µ–≥–º–µ–Ω—Ç–∞: NSX UI ‚Üí Segments ‚Üí k8s-nodes-segment ‚Üí Status –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `Realized`

---

### –ü—Ä–æ–±–ª–µ–º–∞: Ping gateway –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å IP –Ω–∞ VM: `ip addr show` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 172.16.50.10/24)
2. –ü—Ä–æ–≤–µ—Ä—å route: `ip route show` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `default via 172.16.50.1`)
3. –ü—Ä–æ–≤–µ—Ä—å Tier-1 Interface: NSX UI ‚Üí Tier-1 ‚Üí T1-GW-1 ‚Üí Interfaces (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å IP 172.16.50.1)
4. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ VM –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É: vCenter ‚Üí VM ‚Üí Edit Settings ‚Üí Network Adapter ‚Üí Network Label = `k8s-nodes-segment`

---

### –ü—Ä–æ–±–ª–µ–º–∞: Ping –º–µ–∂–¥—É VM –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å DFW Rule 1: NSX UI ‚Üí Security ‚Üí DFW ‚Üí `k8s-inter-node-allow` ‚Üí Applied To = `k8s-nodes`
2. –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –≥—Ä—É–ø–ø–∞ `k8s-nodes` —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–æ–¥—Å–µ—Ç—å 172.16.50.0/24: NSX UI ‚Üí Inventory ‚Üí Groups ‚Üí k8s-nodes ‚Üí Members
3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª: k8s –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –í–´–®–ï default deny
4. –ü—Ä–æ–≤–µ—Ä—å —Å—Ç–∞—Ç—É—Å –ø—Ä–∞–≤–∏–ª–∞: –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å `Published` (–Ω–µ `Draft`)

---

### –ü—Ä–æ–±–ª–µ–º–∞: Ping Internet –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å DFW Rule 3 (egress): –¥–æ–ª–∂–µ–Ω —Ä–∞–∑—Ä–µ—à–∞—Ç—å `k8s-nodes ‚Üí Any`
2. –ü—Ä–æ–≤–µ—Ä—å Tier-1 ‚Üí Tier-0: NSX UI ‚Üí Tier-1 ‚Üí T1-GW-1 ‚Üí Tier-0 Gateway –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å `T0-GW` –∏ —Å—Ç–∞—Ç—É—Å `Connected`
3. –ü—Ä–æ–≤–µ—Ä—å default route –Ω–∞ VM: `ip route show` (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å gateway 172.16.50.1)
4. –ü–æ–ø—Ä–æ–±—É–π –ø–∏–Ω–≥–∞–Ω—É—Ç—å gateway: `ping 172.16.50.1` (–¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å)

---

### –ü—Ä–æ–±–ª–µ–º–∞: DNS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–†–µ—à–µ–Ω–∏–µ:**
1. –ü—Ä–æ–≤–µ—Ä—å `/etc/resolv.conf`: –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å nameservers (8.8.8.8, 8.8.4.4)
2. –ü—Ä–æ–≤–µ—Ä—å netplan: `cat /etc/netplan/01-netcfg.yaml` ‚Üí nameservers –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É–∫–∞–∑–∞–Ω—ã
3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å netplan –∑–∞–Ω–æ–≤–æ: `sudo netplan apply`
4. –ü—Ä–æ–≤–µ—Ä—å egress DFW: –¥–æ–ª–∂–µ–Ω —Ä–∞–∑—Ä–µ—à–∞—Ç—å UDP 53 (DNS)

---

### –ü—Ä–æ–±–ª–µ–º–∞: Gratuitous ARP –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (SpoofGuard –±–ª–æ–∫–∏—Ä—É–µ—Ç)

**–†–µ—à–µ–Ω–∏–µ:**
1. –ù–∞–π–¥–∏ SpoofGuard –≤ NSX UI:
   - –ü–æ–ø—Ä–æ–±—É–π: Networking ‚Üí Segments ‚Üí k8s-nodes-segment ‚Üí Security
   - –ò–ª–∏: System ‚Üí Profiles ‚Üí Segment Profiles ‚Üí Segment Security
2. –î–æ–±–∞–≤—å whitelist:
   - Allowed IP Addresses: `172.16.50.100` (API VIP)
   - –ò –¥–∏–∞–ø–∞–∑–æ–Ω: `172.16.50.200-220` (MetalLB pool)
3. –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏ SpoofGuard –¥–ª—è k8s-nodes —Å–µ–≥–º–µ–Ω—Ç–∞ (–º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –ø—Ä–æ—â–µ –¥–ª—è PoC)

---

## –ò—Ç–æ–≥–æ–≤—ã–π —á–µ–∫-–ª–∏—Å—Ç

**–ü–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º –∫ K8s deployment, —É–±–µ–¥–∏—Å—å:**

- ‚úÖ Segment `k8s-nodes-segment` —Å–æ–∑–¥–∞–Ω (172.16.50.0/24)
- ‚úÖ Tier-1 Interface –Ω–∞—Å—Ç—Ä–æ–µ–Ω (Gateway IP: 172.16.50.1)
- ‚úÖ DFW Group `k8s-nodes` —Å–æ–∑–¥–∞–Ω–∞
- ‚úÖ DFW Rules –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (inter-node, ingress, egress)
- ‚úÖ –í—Å–µ –≤–∞–ª–∏–¥–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã (connectivity, MTU, DNS, ARP)
- ‚úÖ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ (`nsx-configs/segments.md`)

**–ï—Å–ª–∏ –≤—Å–µ ‚úÖ ‚Üí –ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ –≠—Ç–∞–ø—É 0.2 (VM Preparation)!** üéâ

---

**–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! NSX-T –≥–æ—Ç–æ–≤ –¥–ª—è Kubernetes! üöÄ**

–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –°–æ–∑–¥–∞–Ω–∏–µ VM-—à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è K8s –Ω–æ–¥ (Ubuntu 24.04 + kubeadm + containerd).
