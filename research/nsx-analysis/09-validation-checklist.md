# –ß–µ–∫-–ª–∏—Å—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏ NSX-T –¥–ª—è Kubernetes

> **–¶–µ–ª—å:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ NSX-T –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∏ –≥–æ—Ç–æ–≤—ã –¥–ª—è —Ä–∞–∑–≤—ë—Ä—Ç—ã–≤–∞–Ω–∏—è K8s.
> **–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:** –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –∏–∑ 07 –∏–ª–∏ 08 –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.

---

## –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —á–µ–∫-–ª–∏—Å—Ç

1. –ü—Ä–∏–º–µ–Ω–∏–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ NSX-T (DFW, SpoofGuard, etc.)
2. –°–æ–∑–¥–∞–ª 1-2 **—Ç–µ—Å—Ç–æ–≤—ã–µ VM** –≤ —Å–µ–≥–º–µ–Ω—Ç–µ k8s-nodes (–∏–ª–∏ VIP-VM)
3. –ü—Ä–æ—Ö–æ–¥–∏ –ø–æ –∫–∞–∂–¥–æ–º—É –ø—É–Ω–∫—Ç—É —á–µ–∫-–ª–∏—Å—Ç–∞
4. –û—Ç–º–µ—á–∞–π `[x]` –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, `[ ]` –µ—Å–ª–∏ –Ω–µ—Ç
5. –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî —Å–º. —Ä–∞–∑–¥–µ–ª **Troubleshooting** –≤–Ω–∏–∑—É

---

## –†–ê–ó–î–ï–õ 1: Segment –∏ Tier-1 Gateway ‚úÖ

### 1.1. Segment –¥–æ—Å—Ç—É–ø–µ–Ω

- [ ] **–°–µ–≥–º–µ–Ω—Ç –≤–∏–¥–µ–Ω –≤ vSphere** –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ VM (–≤ —Å–ø–∏—Å–∫–µ Networks)
- [ ] **–ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å VM** –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –µ—ë –∫ —ç—Ç–æ–º—É —Å–µ–≥–º–µ–Ω—Ç—É
- [ ] VM –ø–æ–ª—É—á–∞–µ—Ç **IP-–∞–¥—Ä–µ—Å** (—Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–ª–∏ —á–µ—Ä–µ–∑ DHCP)

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- vCenter ‚Üí Create VM ‚Üí Network ‚Üí –≤—ã–±—Ä–∞—Ç—å —Å–µ–≥–º–µ–Ω—Ç ‚Üí –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å–ø–∏—Å–∫–µ
- –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è VM: –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å IP –≤ vCenter –∏–ª–∏ –∑–∞–π—Ç–∏ –≤ VM –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç—å `ip addr show`

---

### 1.2. Gateway –¥–æ—Å—Ç—É–ø–µ–Ω

- [ ] **Gateway IP –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ ping** —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–π VM:
ping <gateway-IP>   # –Ω–∞–ø—Ä–∏–º–µ—Ä, ping 192.168.100.1

# –î–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å (–ø–∏–Ω–≥ –ø—Ä–æ—Ö–æ–¥–∏—Ç)
```

---

### 1.3. IP-–ø–ª–∞–Ω

- [ ] **IP-–ø–ª–∞–Ω –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω** –≤ `nsx-configs/segments.md`
- [ ] **–°–≤–æ–±–æ–¥–Ω—ã—Ö IP –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ** –¥–ª—è –≤—Å–µ—Ö –Ω–æ–¥ + VIP + MetalLB (–º–∏–Ω–∏–º—É–º 29)
- [ ] **MetalLB pool –ù–ï –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç—Å—è** —Å DHCP pool –∏–ª–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ VM

**–ü—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- –û—Ç–∫—Ä—ã—Ç—å `nsx-configs/segments.md` ‚Üí –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Ç–∞–±–ª–∏—Ü–∞ —Å IP allocation
- –ü–∏–Ω–≥–∞–Ω—É—Ç—å –≤—Å–µ IP –∏–∑ MetalLB pool: `for i in {200..220}; do ping -c 1 -W 1 192.168.100.$i; done`
  - –í—Å–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å **–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã** (–Ω–µ –æ—Ç–≤–µ—á–∞—é—Ç) ‚Äî –∑–Ω–∞—á–∏—Ç —Å–≤–æ–±–æ–¥–Ω—ã

---

## –†–ê–ó–î–ï–õ 2: External Connectivity üåê

### 2.1. –ò–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω

- [ ] **–ú–æ–∂–Ω–æ –ø–∏–Ω–≥–∞–Ω—É—Ç—å 8.8.8.8** —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–π VM:
ping 8.8.8.8

# –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
# - –ü—Ä–æ–≤–µ—Ä—å Tier-1 ‚Üí Tier-0 uplink
# - –ü—Ä–æ–≤–µ—Ä—å NAT rules (–µ—Å–ª–∏ –ø–æ–¥—Å–µ—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω–∞—è)
# - –ü—Ä–æ–≤–µ—Ä—å DFW egress rules
```

---

### 2.2. DNS —Ä–∞–±–æ—Ç–∞–µ—Ç

- [ ] **DNS —Ä–µ–∑–æ–ª–≤–∏—Ç –¥–æ–º–µ–Ω—ã** —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–π VM:
nslookup google.com
nslookup apt.kubernetes.io

# –î–æ–ª–∂–Ω—ã –≤–µ—Ä–Ω—É—Ç—å IP-–∞–¥—Ä–µ—Å–∞

# –ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
# - –ü—Ä–æ–≤–µ—Ä—å DNS servers –≤ VM: cat /etc/resolv.conf
# - –ü—Ä–æ–≤–µ—Ä—å DNS –≤ DHCP (–µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è)
# - –ù–∞—Å—Ç—Ä–æ–π DNS –≤—Ä—É—á–Ω—É—é –≤ /etc/netplan/
```

---

### 2.3. vCenter –¥–æ—Å—Ç—É–ø–µ–Ω

- [ ] **vCenter API –æ—Ç–≤–µ—á–∞–µ—Ç** —Å —Ç–µ—Å—Ç–æ–≤–æ–π VM (–Ω—É–∂–Ω–æ –¥–ª—è vSphere CSI)

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–π VM:
curl -k https://<vcenter-IP-or-FQDN>

# –î–æ–ª–∂–Ω–∞ –≤–µ—Ä–Ω—É—Ç—å—Å—è HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏–ª–∏ JSON (–Ω–µ timeout/connection refused)
```

---

## –†–ê–ó–î–ï–õ 3: Distributed Firewall (DFW) üî•

### 3.1. –ì—Ä—É–ø–ø–∞ k8s-nodes —Å–æ–∑–¥–∞–Ω–∞

- [ ] **–ì—Ä—É–ø–ø–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** –≤ NSX UI

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- NSX UI ‚Üí Inventory ‚Üí Groups ‚Üí –Ω–∞–π—Ç–∏ –≥—Ä—É–ø–ø—É "k8s-nodes" (–∏–ª–∏ –∫–∞–∫ —Ç—ã –Ω–∞–∑–≤–∞–ª)

---

### 3.2. DFW –ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã

- [ ] **–ü—Ä–∞–≤–∏–ª–∞ —Å–æ–∑–¥–∞–Ω—ã** —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º (–≤—ã—à–µ deny-all)
- [ ] **–ü—Ä–∞–≤–∏–ª–æ 1:** k8s-nodes ‚Üí k8s-nodes = Allow
- [ ] **–ü—Ä–∞–≤–∏–ª–æ 2:** Any ‚Üí k8s-nodes (NodePort, Ingress) = Allow
- [ ] **–ü—Ä–∞–≤–∏–ª–æ 3:** k8s-nodes ‚Üí Any (egress) = Allow

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- NSX UI ‚Üí Security ‚Üí Distributed Firewall ‚Üí –Ω–∞–π—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞
- Priority –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å ~1000-1002 (–≤—ã—à–µ default deny)

---

### 3.3. –¢—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É VM —Ä–∞–∑—Ä–µ—à—ë–Ω

- [ ] **–î–≤–µ —Ç–µ—Å—Ç–æ–≤—ã–µ VM –º–æ–≥—É—Ç –ø–∏–Ω–≥–æ–≤–∞—Ç—å –¥—Ä—É–≥ –¥—Ä—É–≥–∞**

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –°–æ–∑–¥–∞–π 2 —Ç–µ—Å—Ç–æ–≤—ã–µ VM –≤ —Å–µ–≥–º–µ–Ω—Ç–µ k8s-nodes (–∏–ª–∏ VIP-VM)
# VM1: 192.168.100.10
# VM2: 192.168.100.11

# –ù–∞ VM1:
ping 192.168.100.11   # –î–æ–ª–∂–µ–Ω –ø–∏–Ω–≥–æ–≤–∞—Ç—å—Å—è

# –ù–∞ VM2:
ping 192.168.100.10   # –î–æ–ª–∂–µ–Ω –ø–∏–Ω–≥–æ–≤–∞—Ç—å—Å—è
```

---

### 3.4. –ü–æ—Ä—Ç—ã Kubernetes –¥–æ—Å—Ç—É–ø–Ω—ã

- [ ] **–ü–æ—Ä—Ç 6443 (API) –¥–æ—Å—Ç—É–ø–µ–Ω** –º–µ–∂–¥—É VM
- [ ] **–ü–æ—Ä—Ç 22 (SSH) –¥–æ—Å—Ç—É–ø–µ–Ω** –º–µ–∂–¥—É VM

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ VM1:
nc -zv 192.168.100.11 22     # SSH
nc -zv 192.168.100.11 6443   # Kubernetes API (–±—É–¥–µ—Ç closed, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –ø–æ–∫–∞ –Ω–µ—Ç K8s)

# –î–æ–ª–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å "succeeded" –∏–ª–∏ "connected" (–Ω–µ "filtered" –∏–ª–∏ "no route")
```

---

## –†–ê–ó–î–ï–õ 4: SpoofGuard ‚ö†Ô∏è

### 4.1. SpoofGuard –Ω–∞—Å—Ç—Ä–æ–µ–Ω

**–í—ã–±–µ—Ä–∏ –æ–¥–∏–Ω –∏–∑ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:**

**–í–∞—Ä–∏–∞–Ω—Ç A: Whitelist —Å–æ–∑–¥–∞–Ω (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è Prod)**
- [ ] **API VIP –¥–æ–±–∞–≤–ª–µ–Ω** –≤ SpoofGuard Allowed IP Addresses
- [ ] **MetalLB pool –¥–æ–±–∞–≤–ª–µ–Ω** –≤ SpoofGuard Allowed IP Addresses

**–í–∞—Ä–∏–∞–Ω—Ç B: SpoofGuard –æ—Ç–∫–ª—é—á–µ–Ω (–ø—Ä–æ—â–µ –¥–ª—è PoC)**
- [ ] **SpoofGuard –≤—ã–∫–ª—é—á–µ–Ω** –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–µ –∏–ª–∏ –ø–æ—Ä—Ç–∞—Ö k8s-–Ω–æ–¥
- [ ] **–ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ**, —á—Ç–æ –¥–ª—è Prod –Ω—É–∂–Ω–æ –≤–∫–ª—é—á–∏—Ç—å —Å whitelist

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
- NSX UI ‚Üí Security ‚Üí SpoofGuard ‚Üí Switching Profiles ‚Üí –Ω–∞–π—Ç–∏ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è —Å–µ–≥–º–µ–Ω—Ç–∞

---

### 4.2. Gratuitous ARP —Ä–∞–±–æ—Ç–∞–µ—Ç

- [ ] **–ú–æ–∂–Ω–æ –∞–Ω–æ–Ω—Å–∏—Ä–æ–≤–∞—Ç—å secondary IP** –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π VM (ARP –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è)

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ VM1 (192.168.100.10) –¥–æ–±–∞–≤—å secondary IP:
sudo ip addr add 192.168.100.100/24 dev ens192

# –° VM2 –ø–∏–Ω–≥–∞–Ω–∏ —ç—Ç–æ—Ç IP:
ping 192.168.100.100   # –î–æ–ª–∂–µ–Ω –ø–∏–Ω–≥–æ–≤–∞—Ç—å—Å—è

# –ü—Ä–æ–≤–µ—Ä—å ARP-—Ç–∞–±–ª–∏—Ü—É –Ω–∞ VM2:
arp -n | grep 192.168.100.100
# –î–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å MAC-–∞–¥—Ä–µ—Å VM1

# –û—á–∏—Å—Ç–∏ –ø–æ—Å–ª–µ —Ç–µ—Å—Ç–∞:
sudo ip addr del 192.168.100.100/24 dev ens192
```

**–ï—Å–ª–∏ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- SpoofGuard –±–ª–æ–∫–∏—Ä—É–µ—Ç ‚Üí –¥–æ–±–∞–≤—å IP –≤ whitelist –∏–ª–∏ –æ—Ç–∫–ª—é—á–∏ SpoofGuard

---

## –†–ê–ó–î–ï–õ 5: MTU üìè

### 5.1. MTU –Ω–∞ VM –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π

- [ ] **MTU –Ω–∞ VM vNIC** = Overlay MTU - 100 (–æ–±—ã—á–Ω–æ 1500)

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ —Ç–µ—Å—Ç–æ–≤–æ–π VM:
ip link show ens192   # (–∏–ª–∏ –¥—Ä—É–≥–æ–µ –∏–º—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞)

# –í—ã–≤–æ–¥:
# 2: ens192: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc ...
#                                                    ^^^^
# –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 1500 (–µ—Å–ª–∏ overlay 1600)
```

---

### 5.2. MTU –ø—Ä–æ–≤–µ—Ä–µ–Ω end-to-end

- [ ] **–ë–æ–ª—å—à–∏–µ –ø–∞–∫–µ—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç –±–µ–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏** –º–µ–∂–¥—É VM

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ VM1 –ø–∏–Ω–≥–∞–Ω—É–π VM2 —Å –±–æ–ª—å—à–∏–º –ø–∞–∫–µ—Ç–æ–º (–±–µ–∑ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞—Ü–∏–∏):
ping -M do -s 1400 192.168.100.11

# –ï—Å–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç (0% packet loss) ‚Üí MTU OK ‚úÖ

# –ï—Å–ª–∏ –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏—Ç:
ping -M do -s 1200 192.168.100.11  # –£–º–µ–Ω—å—à–∞–π —Ä–∞–∑–º–µ—Ä –ø–æ–∫–∞ –Ω–µ –ø—Ä–æ–π–¥—ë—Ç
ping -M do -s 1000 192.168.100.11

# –ï—Å–ª–∏ –ø—Ä–æ—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ —Å -s 1000 –∏–ª–∏ –º–µ–Ω—å—à–µ ‚Üí MTU –ø—Ä–æ–±–ª–µ–º–∞!
```

---

### 5.3. MTU –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω

- [ ] **MTU –∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–ø–∏—Å–∞–Ω—ã** –≤ `nsx-configs/segments.md`
  - NSX Overlay MTU: `____`
  - VM vNIC MTU: `____`
  - Cilium MTU (—Ä–∞—Å—Å—á–∏—Ç–∞–Ω–æ): `____`

---

## –†–ê–ó–î–ï–õ 6: DNS –∏ NTP ‚è∞

### 6.1. DNS –Ω–∞—Å—Ç—Ä–æ–µ–Ω

- [ ] **DNS servers –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã** –∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ `nsx-configs/segments.md`
- [ ] **DNS —Ä–∞–±–æ—Ç–∞–µ—Ç** –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö VM (—É–∂–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ –≤ –†–∞–∑–¥–µ–ª–µ 2.2)

---

### 6.2. NTP –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –¥–ª—è PoC, –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è Prod)

- [ ] **NTP servers –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã** (–∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∏–ª–∏ pool.ntp.org)
- [ ] **–í—Ä–µ–º—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ** –Ω–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö VM

**–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:**
```bash
# –ù–∞ VM:
timedatectl status

# –í—ã–≤–æ–¥ –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
# System clock synchronized: yes
# NTP service: active

# –ï—Å–ª–∏ –Ω–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ:
sudo apt install systemd-timesyncd
sudo systemctl enable systemd-timesyncd
sudo systemctl start systemd-timesyncd
```

---

## –†–ê–ó–î–ï–õ 7: –§–∏–Ω–∞–ª—å–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è üìÑ

### 7.1. –§–∞–π–ª segments.md –∑–∞–ø–æ–ª–Ω–µ–Ω

- [ ] **–§–∞–π–ª `nsx-configs/segments.md` —Å–æ–∑–¥–∞–Ω –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω**
  - Segment Name
  - Subnet –∏ Gateway
  - IP Allocation Plan
  - MTU values
  - DNS Servers

---

### 7.2. SpoofGuard whitelist –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω

- [ ] **–§–∞–π–ª `nsx-configs/spoofguard-whitelist.md` —Å–æ–∑–¥–∞–Ω**
  - API VIP IP
  - MetalLB IP Pool

---

### 7.3. DFW rules —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã

- [ ] **DFW –ø—Ä–∞–≤–∏–ª–∞ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã** (–∏–ª–∏ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã)
  - –°–∫—Ä–∏–Ω—à–æ—Ç –∏–ª–∏ JSON export –≤ `nsx-configs/dfw-rules.json`

---

## –†–ê–ó–î–ï–õ 8: –ò—Ç–æ–≥–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ üéâ

### 8.1. –ß–µ–∫-–ª–∏—Å—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

–û—Ç–º–µ—Ç—å –≤—Å–µ –ø—É–Ω–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã:

- [ ] ‚úÖ Segment –≥–æ—Ç–æ–≤ (–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å VM)
- [ ] ‚úÖ IP connectivity —Ä–∞–±–æ—Ç–∞–µ—Ç (ping gateway, ping –º–µ–∂–¥—É VM)
- [ ] ‚úÖ External connectivity —Ä–∞–±–æ—Ç–∞–µ—Ç (ping 8.8.8.8, DNS, vCenter)
- [ ] ‚úÖ DFW rules –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã (—Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É VM —Ä–∞–∑—Ä–µ—à—ë–Ω)
- [ ] ‚úÖ SpoofGuard –Ω–∞—Å—Ç—Ä–æ–µ–Ω (gratuitous ARP —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] ‚úÖ MTU –ø—Ä–æ–≤–µ—Ä–µ–Ω (ping -M do -s 1400 —Ä–∞–±–æ—Ç–∞–µ—Ç)
- [ ] ‚úÖ DNS —Ä–∞–±–æ—Ç–∞–µ—Ç (nslookup google.com)
- [ ] ‚úÖ IP-–ø–ª–∞–Ω –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω (`nsx-configs/segments.md`)
- [ ] ‚úÖ –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ K8s setup

**–ï—Å–ª–∏ –í–°–ï –ø—É–Ω–∫—Ç—ã ‚úÖ ‚Üí –ì–æ—Ç–æ–≤ –∫ –≠—Ç–∞–ø—É 0.2 (VM Preparation)!**

---

## Troubleshooting (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

### –ü—Ä–æ–±–ª–µ–º–∞: Ping gateway –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
- Tier-1 Gateway –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ —Å–µ–≥–º–µ–Ω—Ç—É
- Gateway IP –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- VM –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ IP (–ø—Ä–æ–≤–µ—Ä—å `ip addr show`)

**–†–µ—à–µ–Ω–∏–µ:**
- NSX UI ‚Üí Networking ‚Üí Segments ‚Üí –ø—Ä–æ–≤–µ—Ä—å Connected Gateway
- NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí –ø—Ä–æ–≤–µ—Ä—å Interface –Ω–∞ —Å–µ–≥–º–µ–Ω—Ç–µ

---

### –ü—Ä–æ–±–ª–µ–º–∞: Ping 8.8.8.8 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
- Tier-1 –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ Tier-0
- –ù–µ—Ç default route
- NAT –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω–æ–π –ø–æ–¥—Å–µ—Ç–∏)
- DFW –±–ª–æ–∫–∏—Ä—É–µ—Ç egress

**–†–µ—à–µ–Ω–∏–µ:**
- NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí Tier-0 Connectivity = Connected
- NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí Routing ‚Üí –¥–æ–±–∞–≤–∏—Ç—å 0.0.0.0/0 ‚Üí Tier-0
- NSX UI ‚Üí Networking ‚Üí Tier-1 ‚Üí NAT ‚Üí —Å–æ–∑–¥–∞—Ç—å SNAT rule
- NSX UI ‚Üí Security ‚Üí DFW ‚Üí –¥–æ–±–∞–≤–∏—Ç—å Allow k8s-nodes ‚Üí Any

---

### –ü—Ä–æ–±–ª–µ–º–∞: DNS –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
- DNS servers –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –≤ VM
- DFW –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ—Ä—Ç 53 (UDP)

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å DNS –≤ VM:
cat /etc/resolv.conf   # –î–æ–ª–∂–Ω—ã –±—ã—Ç—å nameserver <IP>

# –ï—Å–ª–∏ –Ω–µ—Ç, –¥–æ–±–∞–≤—å –≤ /etc/netplan/01-netcfg.yaml:
network:
  version: 2
  ethernets:
    ens192:
      dhcp4: true
      nameservers:
        addresses: [8.8.8.8, 8.8.4.4]

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å:
sudo netplan apply
```

---

### –ü—Ä–æ–±–ª–µ–º–∞: Ping –º–µ–∂–¥—É VM –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
- DFW –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ç—Ä–∞—Ñ–∏–∫
- –ì—Ä—É–ø–ø–∞ k8s-nodes –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —ç—Ç–∏ VM
- –ü—Ä–∞–≤–∏–ª–∞ –∏–º–µ—é—Ç –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–Ω–∏–∂–µ deny-all)

**–†–µ—à–µ–Ω–∏–µ:**
- NSX UI ‚Üí Security ‚Üí DFW ‚Üí –ø—Ä–æ–≤–µ—Ä—å –ø–æ—Ä—è–¥–æ–∫ –ø—Ä–∞–≤–∏–ª (k8s –ø—Ä–∞–≤–∏–ª–∞ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤—ã—à–µ)
- NSX UI ‚Üí Inventory ‚Üí Groups ‚Üí k8s-nodes ‚Üí –ø—Ä–æ–≤–µ—Ä—å Members (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–±–µ VM)
- –î–æ–±–∞–≤—å –ø—Ä–∞–≤–∏–ª–æ Allow k8s-nodes ‚Üí k8s-nodes —Å Priority 1000

---

### –ü—Ä–æ–±–ª–µ–º–∞: Secondary IP –Ω–µ –ø–∏–Ω–≥—É–µ—Ç—Å—è (SpoofGuard –±–ª–æ–∫–∏—Ä—É–µ—Ç)

**–ü—Ä–∏—á–∏–Ω—ã:**
- SpoofGuard –≤–∫–ª—é—á–µ–Ω –±–µ–∑ whitelist

**–†–µ—à–µ–Ω–∏–µ:**
- NSX UI ‚Üí Security ‚Üí SpoofGuard ‚Üí –¥–æ–±–∞–≤–∏—Ç—å Allowed IP Address –¥–ª—è secondary IP
- –ò–ª–∏ –æ—Ç–∫–ª—é—á–∏—Ç—å SpoofGuard –Ω–∞ –ø–æ—Ä—Ç–∞—Ö k8s-–Ω–æ–¥ (–º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ)

---

### –ü—Ä–æ–±–ª–µ–º–∞: Ping -M do -s 1400 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç (MTU)

**–ü—Ä–∏—á–∏–Ω—ã:**
- MTU –Ω–∞ VM —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–¥–æ–ª–∂–µ–Ω –±—ã—Ç—å < overlay MTU)
- –ì–¥–µ-—Ç–æ –≤ —Ü–µ–ø–æ—á–∫–µ MTU –º–µ–Ω—å—à–µ

**–†–µ—à–µ–Ω–∏–µ:**
```bash
# –£–º–µ–Ω—å—à–∏ MTU –Ω–∞ VM:
sudo ip link set dev ens192 mtu 1500

# –ü—Ä–æ–≤–µ—Ä—å:
ping -M do -s 1400 <IP>

# –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ, –ø–æ–ø—Ä–æ–±—É–π 1450:
sudo ip link set dev ens192 mtu 1450
```

---

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –≤–∞–ª–∏–¥–∞—Ü–∏–∏:

1. ‚úÖ **–ó–∞–∫—Ä–æ–π –∑–∞–¥–∞—á—É –≠—Ç–∞–ø 0.1** (NSX-T Network Setup) ‚Üê **–¢–´ –ó–î–ï–°–¨**
2. üü° **–ü–µ—Ä–µ—Ö–æ–¥–∏ –∫ –≠—Ç–∞–ø—É 0.2** (VM Preparation)
   - –î–æ–∫—É–º–µ–Ω—Ç: `docs/02-vm-preparation.md`
   - –ó–∞–¥–∞—á–∞: —Å–æ–∑–¥–∞—Ç—å VM-—à–∞–±–ª–æ–Ω –¥–ª—è k8s-–Ω–æ–¥

3. –í—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã NSX-T –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –∏ –≥–æ—Ç–æ–≤—ã –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ Kubernetes!

---

**–ü–æ–∑–¥—Ä–∞–≤–ª—è—é! NSX-T –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω! üéâ**

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞—Ç—å Kubernetes –∫–ª–∞—Å—Ç–µ—Ä.
