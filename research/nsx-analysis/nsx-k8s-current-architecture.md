# Архитектура сети для Kubernetes в NSX-T (текущее состояние)

Документ фиксирует **как сейчас устроена сеть для k8s** в среде vSphere + NSX‑T: какие есть шлюзы, сегменты, адреса, NAT/маршрутизация и базовые правила безопасности. Используется как база при планировании/добавлении новых кластеров.

---

## 1) Общая схема

```
[Корп. сеть / Интернет]
        ↑
   (default route)
        ↑
   ┌────────────────────────────────────────────────────────┐
   │                   NSX‑T (Data Center)                  │
   │                                                        │
   │  Tier‑0: TO‑GW  ── uplinks ── VLAN 172.16.50.0/24      │
   │        └─ default route → апстрим/периметр             │
   │                                                        │
   │  ┌──────────────────────────────────────────────────┐  │
   │  │ T1‑GW‑1 (историч.)                                │  │
   │  │  ├─ Segment VIP‑VM:        172.16.100.0/24        │  │
   │  │  └─ Segment (тест):        172.16.110.0/24        │  │
   │  └──────────────────────────────────────────────────┘  │
   │                                                        │
   │  ┌──────────────────────────────────────────────────┐  │
   │  │ T1‑k8s‑zeon‑dev  (НОВЫЙ кластер, отдельный T1)    │  │
   │  │  └─ k8s-zeon-dev-segment: 10.246.10.0/24 (GW .1)│  │
   │  │     NAT:                                          │  │
   │  │       • No‑SNAT src 10.246.10.0/24 → dst 172.16.50.192/27 │
   │  │       • SNAT   src 10.246.10.0/24 → 172.16.50.170  │  │
   │  └──────────────────────────────────────────────────┘  │
   │                                                        │
   │  ┌──────────────────────────────────────────────────┐  │
   │  │ T1 (Tanzu, существующие)                          │  │
   │  │  Сегменты: 10.244.0.0/20 и др.                    │  │
   │  │  NAT типовой:                                     │  │
   │  │    • No‑SNAT 10.244.0.0/20 → 10.244.0.0/20        │  │
   │  │    • No‑SNAT 10.244.0.0/20 → 172.16.50.192/27     │  │
   │  │    • SNAT   Any → 172.16.50.226 / 172.16.50.229   │  │
   │  └──────────────────────────────────────────────────┘  │
   │                                                        │
   └────────────────────────────────────────────────────────┘
```

---

## 2) Tier‑0 (TO‑GW)

- **Имя:** `TO-GW`
- **Uplink‑интерфейсы:** `172.16.50.11/24`, `172.16.50.12/24` (VLAN 172.16.50.0/24)
  > интерфейсы смотрят в «физическую» сеть/периметр.
- **Маршрутизация:**
  - **Default route `0.0.0.0/0`** в сторону апстрима.
  - **BGP:** выключен.
- **NAT на T0:** не используется (egress‑NAT выполняется на T1 каждого кластера).
- **Gateway Firewall (T0):** дефолтное Allow (блокировок нет).

---

## 3) Tier‑1 шлюзы

### 3.1. `T1‑GW‑1` (историческая часть)
- Подключены сегменты:
  - `VIP‑VM` — `172.16.100.0/24` (DHCP включён; GW 172.16.100.1)
  - `k8s‑nodes‑segment` — `172.16.110.0/24` (тестовая сеть)
- **NAT:** отсутствует.
- **Route Advertisement:** включён для Connected Segments.

### 3.2. `T1‑k8s‑zeon‑dev` (новый k8s‑кластер)
- **Назначение:** изолированный T1 под кластер `zeon‑dev`.
- **Route Advertisement:** включены
  - *All Connected Segments & Service Ports*
  - *All NAT IPs* (для анонса VIP/NAT‑маршрутов вверх)
- **Сегменты:**
  - `k8s-zeon-dev-segment` — `10.246.10.0/24`, **шлюз `10.246.10.1/24`** (overlay)
- **NAT на T1:**
  1) **No‑SNAT**
     - *Source:* `10.246.10.0/24`
     - *Destination:* `172.16.50.192/27` (пул внешних VIP для Ingress/LB)
     - *Назначение:* не «переодевать» исходник при обращении узлов/подов к VIP (исключает hairpin‑проблемы, сохраняет клиентский IP).
  2) **(Опц.) No‑SNAT к внутренним сетям** — добавляется при необходимости, чтобы ходить без NAT (при наличии обратной маршрутизации).
  3) **SNAT (egress)**
     - *Source:* `10.246.10.0/24`
     - *Translated IP:* **`172.16.50.170`**
     - *Назначение:* весь исходящий трафик кластера маскируется в один внешний IP; интернет работает без изменения апстрима.
- **Gateway Firewall (T1):** дефолтное Allow.

### 3.3. T1 (Tanzu, уже существующие)
- **Сети Tanzu:** `10.244.0.0/20` и производные сегменты.
- **Типовая NAT‑схема:**
  - `No‑SNAT` `10.244.0.0/20 → 10.244.0.0/20` (внутрикластерная связность без NAT)
  - `No‑SNAT` `10.244.0.0/20 → 172.16.50.192/27` (доступ к VIP без NAT)
  - `SNAT` `Any → 172.16.50.226` / `172.16.50.229` (egress‑NAT)

---

## 4) Пулы адресов / важные сети

| Назначение                         | Сеть/адрес                 | Комментарий                                   |
|-----------------------------------|----------------------------|-----------------------------------------------|
| Внешняя VLAN (uplinks T0)         | `172.16.50.0/24`           | внешние IP, SNAT‑адреса и VIP‑ы               |
| Пул VIP для Ingress/LB            | `172.16.50.192/27`         | VIP для внешнего доступа к сервисам           |
| SNAT (k8s zeon‑dev)               | `172.16.50.170`            | egress‑IP кластера zeon‑dev                   |
| Сеть узлов k8s zeon‑dev           | `10.246.10.0/24`           | сегмент `k8s-zeon-dev-segment`              |
| Шлюз сети узлов k8s zeon‑dev      | `10.246.10.1/24`           | LIF на T1                                     |
| Сети Tanzu                        | `10.244.0.0/20`            | исторические кластера                         |
| VIP‑VM                            | `172.16.100.0/24`          | сегмент за T1‑GW‑1                            |
| Тестовый сегмент (раньше)         | `172.16.110.0/24`          | за T1‑GW‑1                                    |
| Служебные T0↔T1 линк‑сети         | `100.64.0.0/10`            | автоматически NSX, для меж‑tier связей        |
| DNS, используемый на ВМ           | `172.17.10.3` (+публичные) | для резолва имён                              |

> **Резерв правила:** все новые /24 для «самосборных» кластеров берём из свободного блока (например, `10.246.0.0/16`), **не пересекаться** с Tanzu `10.244.0.0/20` и прочими внутренними сетями.

---

## 5) Как ходит трафик (потоки)

### 5.1. Egress (узел/под → Интернет)
1. Узел `10.246.10.10` отправляет трафик к, напр., `8.8.8.8`.
2. На `T1‑k8s‑zeon‑dev` пакет **не** попадает под No‑SNAT (т.к. не VIP‑пул) и матчится в **SNAT**.
3. Исходный IP меняется на **`172.16.50.170`**.
4. Пакет уходит на `TO‑GW` → апстрим → Интернет.
5. Ответ снаружи приходит на `172.16.50.170` и по NAT‑состоянию возвращается узлу `10.246.10.10`.

### 5.2. Внутренние вызовы к Ingress‑VIP
1. Узел/под обращается к VIP из `172.16.50.192/27` (например, `172.16.50.200`).
2. Срабатывает **No‑SNAT** → исходный IP **не меняется**.
3. Дальше трафик идёт на NSX‑LB/ DNAT‑правила и возвращается корректно (без «hairpin» проблем).

---

## 6) Безопасность

- **Gateway Firewall (T0/T1):** дефолтное Allow (правил‑блокировок нет).
- **Distributed Firewall (DFW):**
  - Есть политика с Allow для группы `k8s‑nodes` (разрешён egress для запуска).
  - Для новых кластеров планируется создавать группы по сегментам/тегам и постепенно ужимать правила.

---

## 7) Операционные заметки

- При создании нового кластера **лучше отдельный T1** + **своя /24** + **свой SNAT‑IP** из `172.16.50.0/24`.
- **Порядок NAT‑правил критичен:** все `No‑SNAT` должны быть **выше** общего `SNAT`.
- Если добавляете `No‑SNAT` к каким‑то внутренним сетям — убедитесь, что у них есть **обратные маршруты** в сеть кластера, иначе ответ не вернётся.
- Для входящего трафика предпочтителен **NSX‑T Load Balancer** (VIP из `172.16.50.192/27`, пулы — NodePort’ы `ingress‑nginx`). На быстрый старт годится **DNAT** на NodePort.

---

## 8) Шаблон для добавления нового T1‑кластера (коротко)

1. **T1:** `T1-k8s-<name>` → HA Active‑Standby → Linked `TO‑GW` → Edge Cluster `EC‑1`.
   Route Advertisement: *Connected Segments* = Yes, *All NAT IPs* = Yes.
2. **Сегмент:** `seg-k8s-<name>-nodes` → Overlay TZ → **Gateway `10.246.X.1/24`**.
   (DHCP — опционально.)
3. **NAT (на T1):**
   - `No‑SNAT` `10.246.X.0/24 → 172.16.50.192/27`
   - *(опц.)* `No‑SNAT` `10.246.X.0/24 → <внутр.сети>`
   - `SNAT` `10.246.X.0/24 → 172.16.50.23Y` (свободный IP)
4. **Ingress:** NSX‑LB (рекомендуется) или DNAT на NodePort.
5. **DFW:** временный Allow egress для группы кластера, затем — ужимать.

---

## 9) Статус на момент актуализации

- `TO‑GW` — default route активен, BGP off, NAT на T0 отсутствует.
- `T1‑k8s‑zeon‑dev` — создан, сегмент `10.246.10.0/24` работает, **интернет есть через SNAT `172.16.50.170`**.
- Пул VIP `172.16.50.192/27` зарезервирован под ingress‑трафик.
- DFW/GW‑FW — без блокирующих правил (дефолт Allow).

---

> Контакты/заметки: DNS `172.17.10.3`; публичные DNS — `8.8.8.8`, `1.1.1.1`.
> Для трассировки используем `Plan & Troubleshoot → Traceflow` и счётчики **Hits** в NAT.
