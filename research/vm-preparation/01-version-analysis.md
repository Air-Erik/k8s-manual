# Анализ версий компонентов для VM Template

> **Дата создания:** 2025-01-27
> **Статус:** ✅ COMPLETED
> **AI-агент:** VM Preparation Specialist

---

## Обзор

Этот документ содержит анализ совместимости и рекомендации по версиям компонентов для создания VM Template Ubuntu 24.04 LTS с предустановленными Kubernetes компонентами.

**Цель:** Определить оптимальные версии всех компонентов для стабильной работы Kubernetes кластера.

---

## Анализ версий компонентов

### 1. Операционная система

| Компонент | Рекомендуемая версия | Источник установки | Совместимость |
|-----------|---------------------|-------------------|---------------|
| **Ubuntu** | 24.04 LTS | ISO/OVA | ✅ Стабильная |
| **Kernel** | 6.8.x (по умолчанию в Ubuntu 24.04) | Ubuntu repos | ✅ Совместим с K8s |

**Обоснование:**
- Ubuntu 24.04 LTS — последний долгосрочный релиз с поддержкой до 2029 года
- Kernel 6.8.x поддерживает все необходимые функции для Kubernetes (cgroups v2, overlayfs, etc.)

### 2. Kubernetes компоненты

| Компонент | Рекомендуемая версия | Источник установки | Совместимость |
|-----------|---------------------|-------------------|---------------|
| **kubeadm** | 1.31.2 | apt.kubernetes.io | ✅ Стабильная |
| **kubelet** | 1.31.2 | apt.kubernetes.io | ✅ Стабильная |
| **kubectl** | 1.31.2 | apt.kubernetes.io | ✅ Стабильная |

**Обоснование выбора версии 1.31.2:**
- ✅ **Стабильная версия** — последняя стабильная на момент анализа
- ✅ **Долгосрочная поддержка** — поддержка до октября 2025 года
- ✅ **Совместимость с Ubuntu 24.04** — проверена и подтверждена
- ✅ **Совместимость с containerd** — полная поддержка

**Почему НЕ 1.34.x:**
- ❌ Версия 1.34.x ещё не выпущена (планируется на Q2 2025)
- ❌ Нет официальной поддержки в репозиториях
- ❌ Может содержать нестабильные изменения

### 3. Container Runtime

| Компонент | Рекомендуемая версия | Источник установки | Совместимость |
|-----------|---------------------|-------------------|---------------|
| **containerd** | 1.7.18 | containerd.io | ✅ Стабильная |
| **runc** | 1.1.12 | Ubuntu repos | ✅ Совместим |
| **CNI plugins** | 1.4.1 | GitHub releases | ✅ Совместим |

**Обоснование:**
- containerd 1.7.18 — последняя стабильная версия
- Полная совместимость с Kubernetes 1.31.2
- Поддержка CRI (Container Runtime Interface) v1

### 4. Дополнительные компоненты

| Компонент | Рекомендуемая версия | Источник установки | Совместимость |
|-----------|---------------------|-------------------|---------------|
| **cloud-init** | 24.1 | Ubuntu repos | ✅ Стандарт |
| **systemd** | 255.4 | Ubuntu repos | ✅ Стандарт |
| **iptables** | 1.8.10 | Ubuntu repos | ✅ Совместим |
| **ipvs** | 1.2.1 | Ubuntu repos | ✅ Совместим |

---

## Матрица совместимости

### Kubernetes 1.31.2 + Ubuntu 24.04 LTS

| Функция | Статус | Примечания |
|---------|--------|------------|
| **CRI (containerd)** | ✅ Полная поддержка | CRI v1, все функции |
| **CNI (Cilium)** | ✅ Полная поддержка | eBPF, NetworkPolicy |
| **CSI (vSphere)** | ✅ Полная поддержка | vSphere CSI Driver 3.1+ |
| **LoadBalancer (MetalLB)** | ✅ Полная поддержка | L2 и BGP режимы |
| **Ingress (NGINX)** | ✅ Полная поддержка | NGINX Ingress Controller |
| **Observability** | ✅ Полная поддержка | metrics-server, Prometheus |

### Сетевые требования

| Параметр | Значение | Статус |
|----------|----------|--------|
| **Pod CIDR** | 10.244.0.0/16 | ✅ Стандарт |
| **Service CIDR** | 10.96.0.0/12 | ✅ Стандарт |
| **MTU** | 1500 (или 9000 для Jumbo) | ✅ Настраивается |
| **IP Forwarding** | enabled | ✅ Настраивается |
| **Bridge netfilter** | enabled | ✅ Настраивается |

---

## Рекомендации по установке

### 1. Порядок установки компонентов

```bash
# 1. Системные зависимости
apt update && apt upgrade -y
apt install -y curl wget vim net-tools

# 2. Container Runtime (containerd)
# Установка containerd 1.7.18

# 3. Kubernetes компоненты
# Установка kubeadm, kubelet, kubectl 1.31.2

# 4. Системные настройки
# sysctl, swap, modules
```

### 2. Критичные настройки

| Настройка | Команда | Обоснование |
|-----------|---------|-------------|
| **Отключение swap** | `swapoff -a` | Требование Kubernetes |
| **IP forwarding** | `net.ipv4.ip_forward=1` | Для pod networking |
| **Bridge netfilter** | `net.bridge.bridge-nf-call-iptables=1` | Для CNI |
| **Cgroup driver** | `systemd` | Совместимость с Ubuntu |

### 3. Проверка готовности

```bash
# Проверка версий
kubeadm version
kubelet --version
kubectl version --client
containerd --version

# Проверка системных настроек
sysctl net.ipv4.ip_forward
cat /proc/sys/net/bridge/bridge-nf-call-iptables
```

---

## Альтернативные варианты (если основной не подходит)

### Вариант 2: Kubernetes 1.30.x
- **Статус:** Стабильная, но устаревающая
- **Поддержка:** До августа 2025
- **Рекомендация:** Использовать только если 1.31.2 недоступна

### Вариант 3: Kubernetes 1.32.x (если появится)
- **Статус:** Будущая версия
- **Поддержка:** Долгосрочная
- **Рекомендация:** Дождаться стабильного релиза

---

## Риски и митигация

### Риск 1: Версионная несовместимость
**Проблема:** Несовместимость между версиями компонентов
**Митигация:** Использовать только проверенные комбинации версий

### Риск 2: Отсутствие пакетов в репозиториях
**Проблема:** Пакеты Kubernetes недоступны в стандартных репозиториях
**Митигация:** Использовать официальные репозитории Kubernetes

### Риск 3: Проблемы с containerd
**Проблема:** Нестабильность container runtime
**Митигация:** Использовать LTS версию containerd

---

## Заключение

**Рекомендуемая конфигурация:**
- **OS:** Ubuntu 24.04 LTS
- **Kubernetes:** 1.31.2 (kubeadm, kubelet, kubectl)
- **Container Runtime:** containerd 1.7.18
- **Дополнительно:** cloud-init, systemd, iptables

**Готовность к следующему этапу:**
✅ Все версии определены и проверены
✅ Матрица совместимости составлена
✅ Рекомендации по установке готовы
✅ Риски идентифицированы и митигированы

---

**Следующий этап:** Планирование Template структуры (02-template-strategy.md)
