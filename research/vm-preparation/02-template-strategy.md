# Стратегия создания VM Template для Kubernetes

> **Дата создания:** 2025-01-27
> **Статус:** ✅ COMPLETED
> **AI-агент:** VM Preparation Specialist

---

## Обзор

Этот документ определяет стратегию создания VM Template для Kubernetes кластера на базе Ubuntu 24.04 LTS с предустановленными компонентами.

**Цель:** Создать универсальный Template, готовый для клонирования как Control Plane, так и Worker нод.

---

## Анализ вариантов архитектуры Template

### Вариант 1: Единый Template (РЕКОМЕНДУЕТСЯ для PoC)

**Описание:**
- Один Template для всех типов нод (Control Plane + Workers)
- Различия задаются через cloud-init при клонировании
- Размеры VM настраиваются при клонировании

**Преимущества:**
- ✅ **Простота поддержки** — один Template для обновления
- ✅ **Быстрое развёртывание** — не нужно поддерживать несколько Template
- ✅ **Гибкость** — можно создать ноду любого типа
- ✅ **Экономия места** — один Template вместо нескольких

**Недостатки:**
- ❌ **Больший размер** — содержит компоненты для всех ролей
- ❌ **Потенциальная избыточность** — Worker ноды не используют etcd

**Рекомендация:** ✅ **Использовать для Dev/PoC кластера**

### Вариант 2: Раздельные Templates (для Production)

**Описание:**
- Отдельный Template для Control Plane нод
- Отдельный Template для Worker нод
- Специализированные конфигурации

**Преимущества:**
- ✅ **Оптимизация** — только необходимые компоненты
- ✅ **Безопасность** — разделение ролей
- ✅ **Производительность** — меньший размер Template

**Недостатки:**
- ❌ **Сложность поддержки** — несколько Template для обновления
- ❌ **Больше места** — несколько Template
- ❌ **Сложность развёртывания** — нужно выбирать правильный Template

**Рекомендация:** ⚠️ **Рассмотреть для Production кластера**

---

## Выбранная стратегия: Единый Template

### Обоснование выбора

**Для Dev/PoC кластера единый Template оптимален:**

1. **Простота операций:**
   - Один Template для обновления
   - Один набор скриптов подготовки
   - Одна процедура валидации

2. **Гибкость развёртывания:**
   - Можно создать ноду любого типа
   - Легко изменить роль ноды
   - Простое масштабирование

3. **Экономия ресурсов:**
   - Меньше места в vSphere
   - Проще backup/restore
   - Меньше сложности в CI/CD

### Параметры Template

| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| **Имя Template** | `k8s-ubuntu2404-template` | Описательное имя |
| **Базовый размер** | 2 vCPU, 8 GB RAM, 80 GB Disk | Минимальный для всех ролей |
| **ОС** | Ubuntu 24.04 LTS Server | Стабильная LTS версия |
| **Архитектура** | x86_64 | Стандартная для vSphere |

---

## Структура Template

### Что ВКЛЮЧАЕТ Template

#### 1. Операционная система
- ✅ Ubuntu 24.04 LTS Server (minimal install)
- ✅ Обновления безопасности (без автоматических)
- ✅ Базовые пакеты (curl, wget, vim, net-tools)
- ✅ SSH сервер настроен
- ✅ Пользователь k8s-admin создан

#### 2. Системные настройки
- ✅ Swap отключён
- ✅ sysctl настроен (ip_forward, bridge-nf-call-iptables)
- ✅ Модули ядра загружены (overlay, br_netfilter)
- ✅ systemd cgroup driver настроен
- ✅ Timezone установлен (UTC)

#### 3. Container Runtime
- ✅ containerd 1.7.18 установлен и настроен
- ✅ runc установлен
- ✅ CNI plugins установлены
- ✅ systemd service настроен

#### 4. Kubernetes компоненты
- ✅ kubeadm 1.31.2 установлен
- ✅ kubelet 1.31.2 установлен и настроен
- ✅ kubectl 1.31.2 установлен
- ✅ Пакеты зафиксированы (hold)

#### 5. Cloud-init подготовка
- ✅ cloud-init установлен и настроен
- ✅ Первичная конфигурация готова
- ✅ Система очищена от instance-specific данных

### Что НЕ включает Template

#### 1. Специфичные настройки
- ❌ IP-адреса (настраиваются через cloud-init)
- ❌ Hostname (настраивается через cloud-init)
- ❌ SSH ключи (добавляются через cloud-init)
- ❌ Роль ноды (определяется при клонировании)

#### 2. Сетевые настройки
- ❌ Статические IP (настраиваются через cloud-init)
- ❌ DNS серверы (настраиваются через cloud-init)
- ❌ MTU настройки (настраиваются через cloud-init)

#### 3. Kubernetes конфигурация
- ❌ kubeadm init (выполняется после клонирования)
- ❌ kubeadm join (выполняется после клонирования)
- ❌ CNI установка (выполняется после клонирования)

---

## Процесс создания Template

### Этап 1: Подготовка базовой VM
1. **Создание VM в vSphere:**
   - Настройки: 2 vCPU, 8 GB RAM, 80 GB Disk
   - Подключение к сегменту k8s-zeon-dev-segment
   - Временный IP: 10.246.10.250

2. **Установка Ubuntu 24.04:**
   - Minimal install
   - Пользователь: k8s-admin
   - SSH: enabled
   - Обновления: manual

3. **Первичная настройка:**
   - SSH ключи оператора
   - Базовые пакеты
   - Отключение автообновлений

### Этап 2: Установка компонентов
1. **Системные настройки:**
   - Отключение swap
   - Настройка sysctl
   - Загрузка модулей ядра

2. **Container Runtime:**
   - Установка containerd
   - Конфигурация systemd
   - Тестирование

3. **Kubernetes компоненты:**
   - Добавление репозитория
   - Установка пакетов
   - Фиксация версий

### Этап 3: Финализация Template
1. **Очистка системы:**
   - Логи, history, temporary files
   - Сброс machine-id
   - SSH host keys

2. **Cloud-init подготовка:**
   - Установка cloud-init
   - Базовая конфигурация
   - Удаление instance-specific данных

3. **Создание Template:**
   - Shutdown VM
   - Convert to Template
   - Настройка metadata

---

## Размеры VM при клонировании

### Control Plane ноды
| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| **vCPU** | 2 (PoC) / 4 (Prod) | Минимум для etcd + API |
| **RAM** | 8 GB (PoC) / 16 GB (Prod) | etcd + API + scheduler |
| **Disk** | 80 GB | OS + etcd data + logs |

### Worker ноды
| Параметр | Значение | Обоснование |
|----------|----------|-------------|
| **vCPU** | 4 (PoC) / 8+ (Prod) | Workloads + kubelet |
| **RAM** | 16 GB (PoC) / 32+ GB (Prod) | Pods + kubelet + system |
| **Disk** | 100 GB | OS + container images + logs |

---

## Cloud-init конфигурации

### Базовая конфигурация (общая)
- Настройка hostname
- Настройка статических IP
- Создание пользователей
- SSH ключи
- DNS настройки

### Специфичные конфигурации
- **Control Plane:** Дополнительные порты, etcd настройки
- **Workers:** Настройки для workloads

---

## Валидация Template

### Проверки готовности Template
- [ ] Все компоненты установлены
- [ ] Версии соответствуют требованиям
- [ ] Системные настройки применены
- [ ] Cloud-init готов
- [ ] Система очищена

### Проверки клонированной VM
- [ ] VM клонируется без ошибок
- [ ] Cloud-init отрабатывает
- [ ] IP настраивается корректно
- [ ] SSH доступ работает
- [ ] Kubernetes компоненты готовы

---

## Рекомендации для Production

### Эволюция Template стратегии

**Для Production кластера рекомендуется:**

1. **Создать специализированные Template:**
   - `k8s-cp-ubuntu2404-template` — для Control Plane
   - `k8s-worker-ubuntu2404-template` — для Workers

2. **Оптимизировать размеры:**
   - Control Plane: только необходимые компоненты
   - Workers: без etcd, с GPU драйверами (если нужно)

3. **Добавить безопасность:**
   - Раздельные SSH ключи
   - Разные пользователи
   - Специфичные firewall правила

---

## Заключение

**Выбранная стратегия:**
- ✅ **Единый Template** для Dev/PoC
- ✅ **Универсальность** — подходит для всех ролей
- ✅ **Простота** — один Template для поддержки
- ✅ **Гибкость** — легко изменить роль ноды

**Готовность к следующему этапу:**
✅ Стратегия определена
✅ Структура Template спланирована
✅ Процесс создания описан
✅ Размеры VM определены

---

**Следующий этап:** Создание пошаговых инструкций (03-base-vm-creation.md)
